/**
 * Calculate Total UI Test Combinations - USING ACTUAL DATA
 * 
 * This script uses the real data from institutes.json to calculate
 * exact combinations possible on the loan query form.
 */

const fs = require('fs');
const path = require('path');

// Load actual data
const institutesPath = path.join(__dirname, 'data', 'institutes.json');
const institutes = JSON.parse(fs.readFileSync(institutesPath, 'utf8'));

// Extract actual options from data
function extractActualOptions() {
  const countries = new Set();
  const universitiesByCountry = {};
  const courses = new Set();
  
  institutes.forEach(inst => {
    // Countries
    if (inst.country) {
      countries.add(inst.country);
      
      // Universities by country
      if (inst.university) {
        if (!universitiesByCountry[inst.country]) {
          universitiesByCountry[inst.country] = new Set();
        }
        universitiesByCountry[inst.country].add(inst.university);
      }
    }
    
    // Courses/Levels
    if (inst.course) {
      courses.add(inst.course);
    }
  });
  
  // Convert Sets to sorted arrays
  const countriesArray = Array.from(countries).sort();
  const coursesArray = Array.from(courses).sort();
  
  // Convert university sets to counts
  const universityCountsByCountry = {};
  let totalUniversities = 0;
  countriesArray.forEach(country => {
    const count = universitiesByCountry[country] ? universitiesByCountry[country].size : 0;
    universityCountsByCountry[country] = count;
    totalUniversities += count;
  });
  
  return {
    countries: countriesArray,
    universityCountsByCountry,
    totalUniversities,
    courses: coursesArray
  };
}

// Load strategic loan amounts (thresholds + mid-points + verification values)
const strategicAmountsPath = path.join(__dirname, 'strategic-loan-amounts.json');
let strategicLoanAmounts = [];

if (fs.existsSync(strategicAmountsPath)) {
  try {
    const strategicData = JSON.parse(fs.readFileSync(strategicAmountsPath, 'utf8'));
    strategicLoanAmounts = strategicData.amounts || [];
    console.log(`âœ… Loaded ${strategicLoanAmounts.length} strategic loan amounts from strategic-loan-amounts.json\n`);
  } catch (e) {
    console.warn('âš ï¸  Failed to load strategic-loan-amounts.json, using base thresholds only\n');
  }
}

// Fallback to base thresholds if strategic amounts not available
if (strategicLoanAmounts.length === 0) {
  strategicLoanAmounts = [
    1, 100000, 400000, 400001, 500000, 500001, 750000, 750001,
    1000000, 1000001, 1500000, 2000000, 2000001, 2500000, 3000000, 3000001,
    4000000, 4000001, 5000000, 6000000, 6200000, 6200001, 7500000,
    8000000, 8000001, 8500000, 10000000, 10000001, 12500000, 15000000,
    20000000, 30000000
  ];
  console.log(`âš ï¸  Using ${strategicLoanAmounts.length} base threshold amounts (strategic amounts file not found)\n`);
}

// Test parameters
const testParams = {
  // Input 1: Gender (from UI - radio buttons)
  genders: ['Male', 'Female'],
  
  // Input 2: Loan Amount (STRATEGIC amounts covering ALL bank logic changes)
  // Includes: thresholds + mid-points + psychological boundaries + verification values
  // Generated by: generate-strategic-loan-amounts.cjs
  loanAmounts: strategicLoanAmounts,
  
  // Input 3: Loan Type (from UI - radio buttons)
  loanTypes: ['Secured', 'Unsecured'],
};

/**
 * Calculate total combinations
 */
function calculateCombinations() {
  console.log('â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•');
  console.log('  LOAN QUERY UI - ACTUAL DATA COMBINATION CALCULATION');
  console.log('â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•\n');
  
  console.log('ðŸ“Š Extracting actual data from institutes.json...\n');
  
  const actualData = extractActualOptions();
  
  // Input counts
  const numGenders = testParams.genders.length;
  const numLoanAmounts = testParams.loanAmounts.length;
  const numLoanTypes = testParams.loanTypes.length;
  const numCountries = actualData.countries.length;
  const numCourses = actualData.courses.length;
  const totalUniversities = actualData.totalUniversities;
  const avgUniversitiesPerCountry = (totalUniversities / numCountries).toFixed(2);
  
  console.log('ðŸ“‹ ACTUAL DATA BREAKDOWN:');
  console.log('â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€');
  console.log(`1. Gender:              ${numGenders} options`);
  console.log(`   Options: ${testParams.genders.join(', ')}`);
  console.log('');
  
  console.log(`2. Loan Amount:         ${numLoanAmounts} threshold values (ACTUAL from ALL 38 banks)`);
  console.log(`   All threshold values where ANY bank's offer changes:`);
  testParams.loanAmounts.slice(0, 10).forEach(amt => {
    const display = amt === 1 ? 'â‚¹1' : 
                   amt >= 10000000 ? `â‚¹${(amt/10000000).toFixed(2)}Cr` : 
                   `â‚¹${(amt/100000).toFixed(2)}L`;
    console.log(`     ${display.padEnd(12)} (â‚¹${amt.toLocaleString('en-IN')})`);
  });
  if (testParams.loanAmounts.length > 10) {
    console.log(`     ... ${testParams.loanAmounts.length - 10} more thresholds`);
    const lastFive = testParams.loanAmounts.slice(-5);
    lastFive.forEach(amt => {
      const display = amt >= 10000000 ? `â‚¹${(amt/10000000).toFixed(2)}Cr` : 
                     `â‚¹${(amt/100000).toFixed(2)}L`;
      console.log(`     ${display.padEnd(12)} (â‚¹${amt.toLocaleString('en-IN')})`);
    });
  }
  console.log('');
  
  console.log(`3. Loan Type:           ${numLoanTypes} options`);
  console.log(`   Options: ${testParams.loanTypes.join(', ')}`);
  console.log('');
  
  console.log(`4. Country:             ${numCountries} countries (ACTUAL)`);
  console.log(`   Examples: ${actualData.countries.slice(0, 5).join(', ')}, ...`);
  console.log('');
  
  console.log(`5. University:          ${totalUniversities} total universities (ACTUAL)`);
  console.log(`   Average per country: ${avgUniversitiesPerCountry}`);
  console.log(`   Range: ${Math.min(...Object.values(actualData.universityCountsByCountry))} to ${Math.max(...Object.values(actualData.universityCountsByCountry))} per country`);
  
  // Show top countries by university count
  const topCountries = Object.entries(actualData.universityCountsByCountry)
    .sort((a, b) => b[1] - a[1])
    .slice(0, 5);
  console.log(`   Top countries:`);
  topCountries.forEach(([country, count]) => {
    console.log(`     - ${country}: ${count} universities`);
  });
  console.log('');
  
  console.log(`6. Level/Course:        ${numCourses} options (ACTUAL)`);
  console.log(`   Examples:`);
  actualData.courses.slice(0, 3).forEach(c => {
    const display = c.length > 60 ? c.substring(0, 57) + '...' : c;
    console.log(`     - ${display}`);
  });
  console.log('');
  
  // Calculate combinations
  // Method 1: Average universities per country (simplified)
  console.log('â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•');
  console.log('ðŸ“Š CALCULATION METHOD 1: USING AVERAGE UNIVERSITIES');
  console.log('â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€');
  const avgCombinations = numGenders * numLoanAmounts * numLoanTypes * numCountries * Math.round(parseFloat(avgUniversitiesPerCountry)) * numCourses;
  
  console.log(`Total = Gender Ã— Loan Amount Ã— Loan Type Ã— Country Ã— Avg Universities Ã— Courses`);
  console.log(`      = ${numGenders} Ã— ${numLoanAmounts} Ã— ${numLoanTypes} Ã— ${numCountries} Ã— ${Math.round(parseFloat(avgUniversitiesPerCountry))} Ã— ${numCourses}`);
  console.log(`      = ${avgCombinations.toLocaleString()} combinations`);
  console.log('');
  
  // Method 2: Sum of (country Ã— its universities Ã— courses)
  console.log('â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•');
  console.log('ðŸ“Š CALCULATION METHOD 2: ACTUAL PER-COUNTRY CALCULATION');
  console.log('â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€');
  console.log('For each country, multiply its actual university count by courses...\n');
  
  let exactTotal = 0;
  actualData.countries.forEach(country => {
    const univCount = actualData.universityCountsByCountry[country];
    const countryCombos = numGenders * numLoanAmounts * numLoanTypes * univCount * numCourses;
    exactTotal += countryCombos;
  });
  
  console.log(`Total = Sum of (Gender Ã— Loan Amount Ã— Loan Type Ã— Universities_in_Country Ã— Courses)`);
  console.log(`      for each of ${numCountries} countries`);
  console.log(`      = ${exactTotal.toLocaleString()} combinations`);
  console.log('');
  
  // Breakdown
  console.log('â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•');
  console.log('ðŸ”¢ STEP-BY-STEP (Method 1 - Average):');
  console.log('â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€');
  let running = numGenders;
  console.log(`Step 1: Gender                     = ${running.toLocaleString()}`);
  
  running *= numLoanAmounts;
  console.log(`Step 2: Ã— Loan Amount             = ${running.toLocaleString()}`);
  
  running *= numLoanTypes;
  console.log(`Step 3: Ã— Loan Type               = ${running.toLocaleString()}`);
  
  running *= numCountries;
  console.log(`Step 4: Ã— Country                 = ${running.toLocaleString()}`);
  
  running *= Math.round(parseFloat(avgUniversitiesPerCountry));
  console.log(`Step 5: Ã— Avg Universities        = ${running.toLocaleString()}`);
  
  running *= numCourses;
  console.log(`Step 6: Ã— Courses/Levels          = ${running.toLocaleString()}`);
  console.log('â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•\n');
  
  // Testing time estimates
  console.log('âš ï¸  PRACTICAL TESTING CONSIDERATIONS:');
  console.log('â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€');
  console.log(`METHOD 1 (Average):     ${avgCombinations.toLocaleString()} combinations`);
  console.log(`METHOD 2 (Exact):       ${exactTotal.toLocaleString()} combinations`);
  console.log('');
  
  // Time calculations
  const secondsPerTest = 1;
  const exactSeconds = exactTotal * secondsPerTest;
  const exactHours = (exactSeconds / 3600).toFixed(1);
  const exactDays = (exactSeconds / 86400).toFixed(1);
  
  console.log(`Time at 1 test/second:  ${exactHours.toLocaleString()} hours (${exactDays} days)`);
  console.log('');
  
  // Sampling strategies
  console.log('RECOMMENDED SAMPLING STRATEGIES:');
  console.log('');
  console.log('Strategy A: Sample universities (5 per country)');
  const strategyA = numGenders * numLoanAmounts * numLoanTypes * numCountries * 5 * numCourses;
  console.log(`  Combinations: ${strategyA.toLocaleString()}`);
  console.log(`  Time: ${(strategyA / 3600).toFixed(1)} hours`);
  console.log('');
  
  console.log('Strategy B: Sample countries (20) + all universities');
  const top20CountriesUnivs = Object.entries(actualData.universityCountsByCountry)
    .sort((a, b) => b[1] - a[1])
    .slice(0, 20)
    .reduce((sum, [_, count]) => sum + count, 0);
  const strategyB = numGenders * numLoanAmounts * numLoanTypes * top20CountriesUnivs * numCourses;
  console.log(`  Combinations: ${strategyB.toLocaleString()}`);
  console.log(`  Time: ${(strategyB / 3600).toFixed(1)} hours`);
  console.log('');
  
  console.log('Strategy C: Sample everything (5 countries, 3 univs each, 10 courses)');
  const strategyC = numGenders * numLoanAmounts * numLoanTypes * 5 * 3 * 10;
  console.log(`  Combinations: ${strategyC.toLocaleString()}`);
  console.log(`  Time: ${(strategyC / 60).toFixed(0)} minutes`);
  console.log('â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•\n');
  
  // Save detailed breakdown
  const report = {
    actualData: {
      countries: numCountries,
      totalUniversities,
      avgUniversitiesPerCountry: parseFloat(avgUniversitiesPerCountry),
      courses: numCourses,
      topCountries: topCountries.map(([c, n]) => ({ country: c, universities: n }))
    },
    testParameters: {
      genders: numGenders,
      loanAmounts: numLoanAmounts,
      loanTypes: numLoanTypes
    },
    calculations: {
      method1_average: avgCombinations,
      method2_exact: exactTotal
    },
    samplingStrategies: {
      strategyA: { combinations: strategyA, description: 'Sample 5 universities per country' },
      strategyB: { combinations: strategyB, description: 'Top 20 countries with all universities' },
      strategyC: { combinations: strategyC, description: 'Sample 5 countries, 3 universities, 10 courses' }
    }
  };
  
  fs.writeFileSync('combination-analysis-actual-data.json', JSON.stringify(report, null, 2));
  console.log('ðŸ“„ Detailed report saved to: combination-analysis-actual-data.json\n');
  
  return report;
}

// Run calculation
if (require.main === module) {
  calculateCombinations();
}

module.exports = { calculateCombinations };
