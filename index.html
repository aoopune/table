<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>Bank Loan Offers</title>
  <link rel="preconnect" href="https://fonts.googleapis.com">
  <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
  <link href="https://fonts.googleapis.com/css2?family=Montserrat:wght@400;500;600;700&display=swap" rel="stylesheet">
  <style>
    :root {
      --bg: #e8f0fe;
      --surface: #fff;
      --surface-soft: rgba(255, 255, 255, 0.95);
      --border: #90caf9;
      --text: #000;
      --muted: #333;
      --accent: #1565c0;
      --accent-hover: #0d47a1;
      --accent-2: #1976d2;
      --success: #22c55e;
      --radius: 14px;
      --shadow: 0 18px 45px rgba(21, 101, 192, 0.15);
    }
    .th-head-icons {
      display: inline-flex;
      align-items: center;
      gap: 0.4rem;
    }
    * { box-sizing: border-box; }
    body {
      margin: 0;
      min-height: 100vh;
      font-family: 'Montserrat', system-ui, sans-serif;
      background: radial-gradient(circle at 15% 0%, rgba(21, 101, 192, 0.12), transparent 42%),
        radial-gradient(circle at 80% 10%, rgba(33, 150, 243, 0.08), transparent 45%),
        linear-gradient(180deg, #e3f2fd 0%, #e8f0fe 100%);
      color: var(--text);
      line-height: 1.5;
    }
    body::before {
      content: '';
      position: fixed;
      inset: 0;
      background-image: radial-gradient(rgba(21, 101, 192, 0.06) 1px, transparent 1px);
      background-size: 26px 26px;
      opacity: 0.5;
      pointer-events: none;
      z-index: -1;
    }
    .wrap {
      max-width: 1240px;
      margin: 0 auto;
      padding: 0 1.5rem 3rem;
    }
    .page-header {
      padding-top: 0;
      padding-bottom: 1.5rem;
      text-align: center;
    }
    .page-header .sub {
      margin-left: auto;
      margin-right: auto;
    }
    h1 {
      margin: 0 0 0.4rem 0;
      font-size: 1.7rem;
      font-weight: 600;
      letter-spacing: -0.01em;
      font-family: 'Montserrat', system-ui, sans-serif;
    }
    .sub {
      color: var(--muted);
      font-size: 0.98rem;
      margin: 0 0 2rem 0;
      max-width: 820px;
    }
    .card {
      background: var(--surface-soft);
      border: 1px solid var(--border);
      border-radius: var(--radius);
      padding: 0.3rem 0.4rem;
      margin-bottom: 0.2rem;
      box-shadow: var(--shadow);
      backdrop-filter: blur(10px);
      position: relative;
      z-index: 10;
    }
    .query-card {
      overflow-x: visible;
      overflow-y: visible;
      width: calc(100% + 3rem);
      margin-left: -1.5rem;
      margin-right: -1.5rem;
      border-radius: 0;
      z-index: 20;
    }
    /* Results table card: MUST stay full-width (same as .query-card) so table uses full horizontal space. Do not remove width/margin. */
    /* CRITICAL: No backdrop-filter/transform/filter here – they create a new containing block and break position:sticky on thead th. */
    .results-card {
      z-index: 1;
      position: relative;
      overflow-x: visible;
      overflow-y: visible;
      width: calc(100% + 3rem);
      margin-left: -1.5rem;
      margin-right: -1.5rem;
      border-radius: 0;
      backdrop-filter: none;
      transform: none;
      filter: none;
    }
    .card h2 {
      font-size: 0.95rem;
      font-weight: 600;
      margin: 0 0 0.3rem 0;
      color: var(--accent);
      text-transform: uppercase;
      letter-spacing: 0.1em;
    }
    .form-row {
      display: grid;
      grid-template-columns: 1fr 0.5fr minmax(14rem, 1fr) 1fr 1fr 1fr minmax(1rem, auto);
      column-gap: 0.2rem;
      row-gap: 0.25rem;
      align-items: start;
      width: 100%;
    }
    .field.submit-field {
      align-self: center;
      justify-self: end;
      align-items: center;
      min-width: 1rem;
      width: fit-content;
    }
    /* Mobile / tablet: 3 inputs left, 3 inputs right, then submit and table */
    @media (max-width: 991px) {
      .form-row {
        grid-template-columns: minmax(11rem, 1fr) minmax(11rem, 1fr);
        grid-template-rows: auto auto auto auto;
        grid-auto-flow: column;
        row-gap: 0.75rem;
        column-gap: 1.25rem;
      }
      .form-row .field label {
        white-space: normal;
        text-align: left;
      }
      .form-row .field > label {
        justify-content: flex-start;
      }
      .form-row .field:nth-child(1),
      .form-row .field:nth-child(3) {
        min-width: 13rem;
      }
      .form-row .choice-group {
        overflow: visible;
        flex-wrap: nowrap;
        min-width: min(100%, 13rem);
      }
      .form-row .choice-option {
        white-space: nowrap;
      }
      .field.submit-field {
        grid-column: 1 / -1;
        grid-row: 4;
        justify-self: center;
        align-self: center;
      }
      .field.submit-field .btn {
        width: auto;
        max-width: 10rem;
      }
    }
    .field.submit-field .btn {
      width: auto;
      max-width: 10rem;
    }
    .field.submit-field .count {
      display: block;
      margin-top: 0;
      font-size: 0.75rem;
      white-space: nowrap;
    }
    .field {
      display: flex;
      flex-direction: column;
      gap: 0.15rem;
      min-width: 0;
    }
    .field label {
      font-size: 0.85rem;
      font-weight: 600;
      color: var(--muted);
      text-transform: none;
      letter-spacing: 0;
      line-height: 1.3;
      white-space: nowrap;
      text-align: center;
    }
    .field > label {
      display: inline-flex;
      align-items: center;
      justify-content: center;
      gap: 0.2rem;
      width: 100%;
    }
    .field > label .th-info-icon {
      margin-left: 0.1rem;
    }
    .field input:not([type="radio"]), .field select {
      font: inherit;
      font-family: 'Montserrat', system-ui, sans-serif;
      font-size: 0.8rem;
      padding: 0.2rem 0.2rem;
      border: 1px solid #000;
      border-radius: 1px;
      background: #fff;
      color: var(--text);
      min-width: 0;
      min-height: 36px;
      width: 100%;
      box-sizing: border-box;
    }
    .form-row .field:nth-child(2) {
      align-items: center;
    }
    #amount {
      width: calc(13ch + 0.5rem);
      max-width: calc(13ch + 0.5rem);
      box-sizing: border-box;
    }
    .choice-group {
      display: flex;
      gap: 0.5rem;
      margin-top: 0;
      width: 100%;
      padding: 0.4rem 0.8rem;
      border: 1px solid transparent;
      box-sizing: border-box;
      min-height: 36px;
      align-items: center;
      overflow: visible;
      background: transparent;
    }
    .choice-option {
      display: flex;
      align-items: center;
      gap: 0.3rem;
      cursor: pointer;
      flex-shrink: 0;
      white-space: nowrap;
    }
    .choice-option input[type="radio"] {
      width: 14px;
      height: 14px;
      cursor: pointer;
      margin: 0;
      flex-shrink: 0;
    }
    .choice-option span {
      font-size: 0.92rem;
      font-weight: 400;
      cursor: pointer;
      line-height: 1.3;
      margin: 0;
      color: var(--text);
      background: transparent;
    }
    .combo {
      position: relative;
      min-width: 0;
    }
    .combo input {
      width: 100%;
      min-width: 0;
      min-height: 46px;
      padding: 0.65rem 5rem 0.65rem 0.9rem;
      font-size: 0.72rem;
      box-sizing: border-box;
      border: 1px solid #000;
      border-radius: 1px;
      background: #fff;
      color: var(--text);
    }
    .combo-clear {
      position: absolute;
      top: 50%;
      right: 1.2rem;
      transform: translateY(-50%);
      border: none;
      background: transparent;
      color: var(--muted);
      cursor: pointer;
      font-size: 0.9rem;
      padding: 0.2rem 0.3rem;
      line-height: 1;
      display: none;
    }
    .combo-clear:hover {
      color: var(--text);
    }
    .combo-toggle {
      position: absolute;
      top: 50%;
      right: 0;
      transform: translateY(-50%);
      border: none;
      background: transparent;
      color: var(--muted);
      cursor: pointer;
      font-size: 0.9rem;
      padding: 0.2rem 0.4rem;
      line-height: 1;
    }
    @media (max-width: 768px) {
      .combo input {
        min-height: 48px;
        padding: 0.75rem 5.25rem 0.75rem 1rem;
      }
      .combo-clear { right: 2.85rem; font-size: 0.95rem; }
      .combo-toggle { right: 0; font-size: 0.95rem; }
    }
    @media (max-width: 480px) {
      .combo input {
        min-height: 50px;
        padding: 0.85rem 5.5rem 0.85rem 1.1rem;
      }
      .combo-clear { right: 1.5rem; font-size: 1rem; }
      .combo-toggle { right: 0; font-size: 1rem; }
    }
    .combo-menu {
      position: absolute;
      left: 0;
      right: 0;
      top: calc(100% + 4px);
      min-width: 22rem;
      max-height: 220px;
      overflow-y: auto;
      overflow-x: auto;
      background: #fff;
      border: 1px solid var(--border);
      border-radius: 8px;
      box-shadow: var(--shadow);
      z-index: 10000;
      display: none;
    }
    .combo-option {
      width: 100%;
      min-width: max-content;
      text-align: left;
      border: none;
      background: transparent;
      color: var(--text);
      font: inherit;
      font-family: 'Montserrat', system-ui, sans-serif;
      font-size: 0.72rem;
      white-space: nowrap;
      padding: 0 0.5rem;
      cursor: pointer;
    }
    .combo-option:hover {
      background: rgba(21, 101, 192, 0.08);
    }
    .field input:focus, .field select:focus {
      outline: none;
      border-color: var(--accent);
      box-shadow: 0 0 0 3px rgba(21, 101, 192, 0.2);
    }
    .btn {
      font: inherit;
      font-weight: 600;
      padding: 0.3rem 1rem;
      background: linear-gradient(135deg, var(--accent), #1976d2);
      color: #fff;
      border: none;
      border-radius: 6px;
      font-size: 0.92rem;
      cursor: pointer;
      white-space: nowrap;
      transition: background 0.2s, box-shadow 0.2s, transform 0.15s;
      height: 36px;
      min-width: 90px;
      box-shadow: 0 8px 20px rgba(21, 101, 192, 0.25);
    }
    .btn:hover { transform: translateY(-1px); box-shadow: 0 12px 24px rgba(21, 101, 192, 0.3); }
    .btn:disabled { opacity: 0.6; cursor: not-allowed; }
    .results-head {
      display: flex;
      justify-content: space-between;
      align-items: center;
      flex-wrap: wrap;
      gap: 0.75rem;
      margin-bottom: 1rem;
    }
    .results-head h2 { margin: 0; }
    .count {
      font-size: 0.9rem;
      color: var(--muted);
    }
    .count strong { color: var(--accent); }
    .query-summary { font-size: 0.85rem; margin: 0 0 0.75rem 0; }
    .query-summary.muted { color: var(--muted); }
    code { font-family: 'Montserrat', system-ui, sans-serif; font-size: 0.9em; background: rgba(21, 101, 192, 0.12); padding: 0.15em 0.4em; border-radius: 4px; color: var(--text); }
    .processing-fees-cell { position: relative; display: inline-block; padding-right: 1.4em; }
    .refundable-star { position: absolute; top: 0; right: 0; cursor: help; color: var(--accent); font-size: 0.85em; }
    .refundable-tooltip { position: fixed; background: #fff; border: 1px solid var(--border); padding: 0.35rem 0.6rem; border-radius: 6px; font-size: 0.8rem; z-index: 1000; box-shadow: var(--shadow); pointer-events: none; color: var(--text); }
    .table-wrap {
      --sticky-col1-width: 15ch;
      --sticky-col2-width: 10ch;
      --sticky-col3-width: 3.5ch;
      border-radius: 0;
      border: 1px solid var(--border);
      background: #fff;
      position: relative;
      z-index: 1;
    }
    /* Single scroll container: when scrolling DOWN header row sticks; when scrolling RIGHT Lender, Sector, checkbox cols stick */
    /* Fixed height so vertical scroll happens HERE (not on page) – required for sticky header */
    .table-scroll-inner {
      overflow: auto;
      width: 100%;
      height: 75vh;
      max-height: 75vh;
      -webkit-overflow-scrolling: touch;
      scrollbar-width: thin;
      scrollbar-color: rgba(21, 101, 192, 0.3) transparent;
    }
    .table-scroll-inner::-webkit-scrollbar {
      width: 8px;
      height: 8px;
    }
    .table-scroll-inner::-webkit-scrollbar-track {
      background: transparent;
    }
    .table-scroll-inner::-webkit-scrollbar-thumb {
      background: rgba(21, 101, 192, 0.35);
      border-radius: 0;
    }
    table {
      width: 100%;
      min-width: max-content;
      border-collapse: separate;
      border-spacing: 0;
      font-size: 0.78rem;
    }
    #results-table col.sticky-col-1 { width: var(--sticky-col1-width); }
    #results-table col.sticky-col-2 { width: var(--sticky-col2-width); }
    #results-table col.sticky-col-3 { width: var(--sticky-col3-width); }
    th, td {
      text-align: center;
      padding: 0.2rem 0.3rem;
      line-height: 1.5;
      border-bottom: 1px solid var(--border);
      border-right: 1px solid var(--border);
      white-space: nowrap;
      min-height: 1.8em;
      height: 1.8em;
    }
    #results-table tbody tr,
    #results-table td {
      background: #fff !important;
      color: #000;
      box-sizing: border-box;
    }
    #results-table th:last-child,
    #results-table td:last-child { border-right: none; }
    th {
      font-weight: 600;
      color: var(--muted);
      font-size: 0.68rem;
      letter-spacing: 0.04em;
      white-space: nowrap;
    }
    .th-head {
      display: inline-flex;
      flex-direction: column;
      align-items: center;
      gap: 0.25rem;
    }
    .th-head-label { display: block; }
    .th-head-icons {
      display: inline-flex;
      align-items: center;
      gap: 0.5rem;
    }
    .th-sort-filter-icon {
      display: inline-flex;
      align-items: center;
      justify-content: center;
      flex-shrink: 0;
      width: 1rem;
      height: 1rem;
      color: var(--muted);
      opacity: 0.85;
    }
    .th-sort-filter-icon svg {
      width: 100%;
      height: 100%;
    }
    th:hover .th-sort-filter-icon {
      color: var(--accent);
      opacity: 1;
    }
    #results-table thead {
      position: relative;
      z-index: 1;
    }
    #results-table thead th {
      position: -webkit-sticky;
      position: sticky;
      top: 0;
      z-index: 20;
      background: var(--accent);
      color: #fff;
      box-shadow: 0 1px 0 rgba(255,255,255,0.2);
    }
    #results-table thead th:first-child {
      position: -webkit-sticky;
      position: sticky;
      top: 0;
      left: 0;
      z-index: 21;
      width: var(--sticky-col1-width);
      min-width: var(--sticky-col1-width);
      max-width: var(--sticky-col1-width);
      box-sizing: border-box;
      box-shadow: 0 1px 0 rgba(255,255,255,0.2);
      background: var(--accent);
      color: #fff;
      will-change: transform;
      white-space: normal;
      word-wrap: break-word;
      overflow-wrap: break-word;
      height: auto;
      min-height: 1.8em;
      text-align: left;
    }
    #results-table thead th:nth-child(2) {
      position: -webkit-sticky;
      position: sticky;
      top: 0;
      left: var(--sticky-col1-width);
      z-index: 21;
      width: var(--sticky-col2-width);
      min-width: var(--sticky-col2-width);
      max-width: var(--sticky-col2-width);
      box-sizing: border-box;
      background: var(--accent);
      color: #fff;
      box-shadow: 0 1px 0 rgba(255,255,255,0.2);
      will-change: transform;
      white-space: normal;
      word-wrap: break-word;
      overflow-wrap: break-word;
      height: auto;
      min-height: 1.8em;
      text-align: left;
    }
    #results-table thead th:nth-child(3) {
      position: -webkit-sticky;
      position: sticky;
      top: 0;
      left: calc(var(--sticky-col1-width) + var(--sticky-col2-width));
      z-index: 21;
      width: var(--sticky-col3-width);
      min-width: var(--sticky-col3-width);
      max-width: var(--sticky-col3-width);
      box-sizing: border-box;
      padding-left: 0;
      padding-right: 0;
      background: var(--accent);
      color: #fff;
      box-shadow: 0 1px 0 rgba(255,255,255,0.2);
      will-change: transform;
    }
    #results-table thead th.offer-checkbox-header {
      padding: 0.2rem 0;
      text-align: center;
    }
    #results-table thead th.offer-checkbox-header .th-head {
      padding: 0;
      display: inline-flex;
      justify-content: center;
      align-items: center;
    }
    #results-table thead th.offer-checkbox-header input { cursor: pointer; accent-color: #fff; }
    #results-table thead .th-sort-filter-icon,
    #results-table thead .th-info-icon { color: rgba(255,255,255,0.95); }
    #results-table thead .th-sort-filter-icon:hover,
    #results-table thead .th-info-icon:hover,
    #results-table thead .th-sort-filter-icon--active { color: #fff; opacity: 1; }
    #results-table thead th.header-has-sort-or-filter {
      background: #0d47a1 !important;
      box-shadow: inset 0 0 0 3px #fff;
    }
    #results-table thead th.header-has-sort-or-filter:first-child,
    #results-table thead th.header-has-sort-or-filter:nth-child(2),
    #results-table thead th.header-has-sort-or-filter:nth-child(3) {
      background: #0d47a1 !important;
      box-shadow: inset 0 0 0 3px #fff;
    }
    #results-table th[data-column-key="Course"],
    #results-table th[data-column-key="Delayed EMI payment"],
    #results-table th[data-column-key="Qualification"],
    #results-table th[data-column-key="Moratorium period"],
    #results-table th[data-column-key="Preferred University"],
    #results-table td[data-column-key="Course"],
    #results-table td[data-column-key="Delayed EMI payment"],
    #results-table td[data-column-key="Qualification"],
    #results-table td[data-column-key="Moratorium period"],
    #results-table td[data-column-key="Preferred University"] {
      white-space: normal;
      word-wrap: break-word;
      overflow-wrap: break-word;
      height: auto;
      min-height: 1.8em;
      max-width: 11em;
      box-sizing: border-box;
    }
    tr:last-child td { border-bottom: none; }
    tr:hover td { background: #fff; }
    tr:hover td.bank-name-cell,
    tr:hover td.sector-name-cell { background: #fff; }
    td .num { font-family: 'Montserrat', system-ui, sans-serif; }
    td.bank-name-cell,
    td.sector-name-cell {
      vertical-align: top;
      background: #fff;
      border-right: 1px solid var(--border);
    }
    #results-table td.bank-name-cell {
      position: -webkit-sticky;
      position: sticky;
      left: 0;
      z-index: 2;
      width: var(--sticky-col1-width);
      min-width: var(--sticky-col1-width);
      max-width: var(--sticky-col1-width);
      box-sizing: border-box;
      white-space: normal;
      word-wrap: break-word;
      overflow-wrap: break-word;
      height: auto;
      min-height: 1.8em;
      text-align: left;
      background: #fff;
      border-right: 1px solid var(--border);
      box-shadow: 1px 0 2px rgba(21, 101, 192, 0.06);
    }
    #results-table td.sector-name-cell {
      position: -webkit-sticky;
      position: sticky;
      left: var(--sticky-col1-width);
      z-index: 3;
      width: var(--sticky-col2-width);
      min-width: var(--sticky-col2-width);
      max-width: var(--sticky-col2-width);
      box-sizing: border-box;
      white-space: normal;
      word-wrap: break-word;
      overflow-wrap: break-word;
      height: auto;
      min-height: 1.8em;
      text-align: left;
      background: #fff;
      border-right: 1px solid var(--border);
      box-shadow: 2px 0 4px rgba(21, 101, 192, 0.08);
    }
    #results-table td.offer-checkbox-cell {
      position: -webkit-sticky;
      position: sticky;
      left: calc(var(--sticky-col1-width) + var(--sticky-col2-width));
      z-index: 10;
      width: var(--sticky-col3-width);
      min-width: var(--sticky-col3-width);
      max-width: var(--sticky-col3-width);
      box-sizing: border-box;
      padding: 0.2rem 0;
      background: #fff;
      border-right: 1px solid var(--border);
      box-shadow: 1px 0 2px rgba(21, 101, 192, 0.06);
      vertical-align: middle;
      text-align: center;
    }
    #results-table td.offer-checkbox-cell .offer-checkbox,
    #results-table td.offer-checkbox-cell input {
      display: inline-block;
      vertical-align: middle;
      cursor: pointer;
      accent-color: var(--accent);
    }
    tr:hover td.offer-checkbox-cell { background: #fff; }
    td.bank-name-cell { font-weight: 600; }
    td.sector-name-cell { font-weight: 500; }
    tr.bank-group-first td {
      border-top: 1px solid #000;
    }
    tr.bank-group-last td {
      border-bottom: 1px solid #000;
    }
    /* Lender/sector cells have rowspan in grouped view – give them the same bottom border so the line runs full width */
    tr.bank-group-first td.bank-name-cell,
    tr.bank-group-first td.sector-name-cell {
      border-bottom: 1px solid #000;
    }
    .listed-universities-trigger {
      border: none;
      background: transparent;
      color: var(--accent);
      text-decoration: underline;
      cursor: pointer;
      padding: 0;
      font: inherit;
      text-align: left;
    }
    .lender-name {
      display: block;
      font-weight: 600;
      margin-bottom: 0.35rem;
    }
    .view-details-trigger {
      border: none;
      background: transparent;
      color: var(--accent);
      text-decoration: underline;
      cursor: pointer;
      padding: 0;
      font: inherit;
      font-size: 0.82rem;
      text-align: left;
    }
    .listed-popup-backdrop {
      position: fixed;
      inset: 0;
      background: rgba(13, 71, 161, 0.25);
      display: none;
      align-items: center;
      justify-content: center;
      z-index: 1000;
      padding: 1rem;
    }
    .listed-popup {
      width: min(640px, 94vw);
      max-height: 78vh;
      overflow: auto;
      background: #fff;
      border: 1px solid var(--border);
      border-radius: var(--radius);
      box-shadow: var(--shadow);
      padding: 1rem;
    }
    .listed-popup-head {
      display: flex;
      justify-content: space-between;
      align-items: center;
      gap: 0.75rem;
      margin-bottom: 0.75rem;
    }
    .listed-popup-title {
      margin: 0;
      font-size: 1rem;
      font-weight: 600;
    }
    .listed-popup-close {
      border: 1px solid var(--border);
      background: rgba(255, 255, 255, 0.95);
      color: var(--text);
      border-radius: 6px;
      cursor: pointer;
      padding: 0.3rem 0.55rem;
      font: inherit;
    }
    .listed-popup-list {
      margin: 0;
      padding-left: 1.1rem;
    }
    .listed-popup-list li {
      margin: 0.25rem 0;
    }
    .listed-popup-meta {
      color: var(--muted);
      font-size: 0.85rem;
      margin: 0 0 0.6rem 0;
    }
    .listed-popup-tools {
      display: flex;
      justify-content: space-between;
      align-items: center;
      gap: 0.6rem;
      margin: 0 0 0.6rem 0;
    }
    .listed-popup-search {
      flex: 1;
      min-width: 180px;
      max-width: 320px;
      border: 1px solid var(--border);
      background: rgba(255, 255, 255, 0.95);
      color: var(--text);
      border-radius: 6px;
      padding: 0.35rem 0.55rem;
      font: inherit;
      font-family: 'Montserrat', system-ui, sans-serif;
      font-size: 0.84rem;
    }
    .listed-popup-switch {
      border: 1px solid var(--border);
      background: rgba(255, 255, 255, 0.95);
      color: var(--text);
      border-radius: 6px;
      cursor: pointer;
      padding: 0.35rem 0.6rem;
      font: inherit;
      font-size: 0.85rem;
    }
    .listed-criteria-group {
      margin: 0.75rem 0 0.9rem 0;
    }
    .listed-criteria-head {
      margin: 0 0 0.35rem 0;
      font-size: 0.86rem;
      color: var(--muted);
      text-transform: uppercase;
      letter-spacing: 0.03em;
    }
    .details-sections {
      display: grid;
      grid-template-columns: 1fr;
      gap: 0.7rem;
    }
    .details-section {
      border: 1px solid rgba(255, 255, 255, 0.08);
      border-radius: 8px;
      padding: 0.6rem 0.7rem;
      background: rgba(21, 101, 192, 0.06);
    }
    .details-section-title {
      margin: 0 0 0.35rem 0;
      font-size: 0.82rem;
      color: var(--muted);
      text-transform: uppercase;
      letter-spacing: 0.03em;
    }
    .details-section-list {
      margin: 0;
      padding-left: 1.1rem;
    }
    .details-section-list li {
      margin: 0.2rem 0;
    }
    .details-section-empty {
      margin: 0;
      color: var(--text);
      font-size: 0.9rem;
    }
    .audience-rate {
      display: flex;
      align-items: center;
      justify-content: center;
      position: relative;
      width: 100%;
      padding-right: 1.5rem;
      box-sizing: border-box;
    }
    .audience-badge {
      position: absolute;
      right: 0;
      display: inline-block;
      border: 1px solid rgba(255, 255, 255, 0.12);
      border-radius: 999px;
      padding: 0.02rem 0.36rem;
      font-size: 0.64rem;
      color: var(--muted);
      white-space: nowrap;
      background: rgba(21, 101, 192, 0.08);
      line-height: 1.2;
    }
    .audience-badge[data-audience-tooltip] {
      cursor: pointer;
    }
    td.changed-cell {
      animation: changedCellFlash 3s ease-out;
    }
    @keyframes changedCellFlash {
      0% {
        box-shadow: inset 0 0 0 9999px rgba(250, 204, 21, 0.38);
      }
      100% {
        box-shadow: inset 0 0 0 9999px rgba(250, 204, 21, 0);
      }
    }
    .empty {
      text-align: center;
      padding: 3rem 1rem;
      color: var(--muted);
    }
    .error {
      background: rgba(239, 68, 68, 0.12);
      border: 1px solid rgba(239, 68, 68, 0.3);
      color: #fca5a5;
      padding: 0.75rem 1rem;
      border-radius: 8px;
      margin-bottom: 1rem;
      font-size: 0.9rem;
    }
    .loading { opacity: 0.7; pointer-events: none; }
    .th-sort-filter-icon { cursor: pointer; }
    .th-sort-filter-icon--active { color: var(--accent-2); opacity: 1; }
    .th-info-icon {
      display: inline-flex;
      align-items: center;
      justify-content: center;
      flex-shrink: 0;
      width: 1rem;
      height: 1rem;
      margin-left: 0.15rem;
      color: var(--muted);
      opacity: 0.85;
      cursor: help;
      border-radius: 50%;
      border: 1px solid currentColor;
      font-size: 0.65rem;
      font-weight: 700;
      line-height: 1;
    }
    .th-info-icon:hover { color: var(--accent-2); opacity: 1; }
    .th-info-icon svg { width: 100%; height: 100%; }
    .th-info-popover {
      position: fixed;
      z-index: 10003;
      max-width: 280px;
      padding: 0.6rem 0.75rem;
      background: var(--surface);
      border: 1px solid var(--border);
      border-radius: 8px;
      box-shadow: var(--shadow);
      font-size: 0.85rem;
      font-weight: 400;
      color: var(--text);
      line-height: 1.4;
      white-space: pre-line;
      display: none;
    }
    .th-info-popover.is-open { display: block; }
    .column-filter-dropdown {
      position: fixed;
      z-index: 10001;
      min-width: 200px;
      max-width: 320px;
      max-height: 70vh;
      overflow-y: auto;
      overflow-x: hidden;
      background: var(--surface);
      border: 1px solid var(--border);
      border-radius: var(--radius);
      box-shadow: var(--shadow);
      padding: 0.35rem 0;
      display: none;
    }
    .column-filter-dropdown.is-open { display: block; }
    .column-filter-dropdown .cfd-item {
      display: block;
      width: 100%;
      text-align: left;
      border: none;
      background: transparent;
      color: var(--text);
      padding: 0.45rem 0.75rem;
      font: inherit;
      font-size: 0.88rem;
      cursor: pointer;
    }
    .column-filter-dropdown .cfd-item:hover { background: rgba(21, 101, 192, 0.12); }
    .column-filter-dropdown .cfd-item.cfd-active { background: rgba(21, 101, 192, 0.18); font-weight: 600; }
    .column-filter-dropdown .cfd-submenu {
      position: absolute;
      left: 100%;
      top: 0;
      min-width: 180px;
      background: var(--surface);
      border: 1px solid var(--border);
      border-radius: var(--radius);
      box-shadow: var(--shadow);
      padding: 0.35rem 0;
      display: none;
    }
    .column-filter-dropdown .cfd-submenu.is-open { display: block; }
    .column-filter-dropdown .cfd-condition {
      padding: 0.5rem 0.75rem;
      border-top: 1px solid rgba(255,255,255,0.06);
    }
    .column-filter-dropdown .cfd-condition select,
    .column-filter-dropdown .cfd-condition input {
      width: 100%;
      margin-top: 0.25rem;
      padding: 0.2rem 0.2rem;
      font: inherit;
      font-family: 'Montserrat', system-ui, sans-serif;
      font-size: 0.8rem;
      background: rgba(255, 255, 255, 0.98);
      border: 1px solid var(--border);
      border-radius: 1px;
      color: var(--text);
      min-height: 36px;
      box-sizing: border-box;
    }
    .column-filter-dropdown .cfd-condition select:focus,
    .column-filter-dropdown .cfd-condition input:focus {
      outline: none;
      border-color: var(--accent);
      box-shadow: 0 0 0 3px rgba(21, 101, 192, 0.2);
    }
    .column-filter-dropdown .cfd-condition-ok { margin-top: 0.5rem; }
    .filter-by-values-panel {
      position: fixed;
      z-index: 10002;
      min-width: 260px;
      max-width: 360px;
      max-height: 70vh;
      display: flex;
      flex-direction: column;
      overflow: hidden;
      background: var(--surface);
      border: 1px solid var(--border);
      border-radius: var(--radius);
      box-shadow: var(--shadow);
      padding: 0.75rem;
    }
    .filter-by-values-panel:not(.is-open) { display: none; }
    .filter-by-values-panel.is-open { display: flex; }
    .filter-by-values-panel .fbv-title { font-weight: 600; margin: 0 0 0.5rem 0; font-size: 0.9rem; flex-shrink: 0; }
    .filter-by-values-panel .fbv-toolbar { display: flex; justify-content: space-between; align-items: center; gap: 0.5rem; margin-bottom: 0.4rem; font-size: 0.82rem; color: var(--muted); flex-shrink: 0; }
    .filter-by-values-panel .fbv-search {
      width: 100%;
      padding: 0.2rem 0.2rem;
      margin-bottom: 0.5rem;
      font: inherit;
      font-family: 'Montserrat', system-ui, sans-serif;
      font-size: 0.8rem;
      background: rgba(255, 255, 255, 0.98);
      border: 1px solid var(--border);
      border-radius: 1px;
      color: var(--text);
      min-height: 36px;
      flex-shrink: 0;
      box-sizing: border-box;
    }
    .filter-by-values-panel .fbv-search:focus {
      outline: none;
      border-color: var(--accent);
      box-shadow: 0 0 0 3px rgba(21, 101, 192, 0.2);
    }
    .filter-by-values-panel .fbv-list { max-height: 280px; min-height: 0; overflow-y: auto; overflow-x: hidden; }
    .filter-by-values-panel .fbv-row { display: flex; align-items: center; gap: 0.4rem; padding: 0.25rem 0; cursor: pointer; }
    .filter-by-values-panel .fbv-row:hover { background: rgba(45,212,191,0.1); }
    .filter-by-values-panel .fbv-row input { margin: 0; }
    .filter-by-values-panel .fbv-footer { display: flex; justify-content: flex-end; gap: 0.5rem; margin-top: 0.5rem; padding-top: 0.5rem; border-top: 1px solid var(--border); flex-shrink: 0; }
    .cfp-column-label {
      font-weight: 700;
      font-size: 0.75rem;
      color: var(--accent);
      margin: 0 0 0.5rem 0;
      padding-bottom: 0.4rem;
      border-bottom: 1px solid var(--border);
    }
    .column-filter-panel {
      display: flex;
      flex-direction: column;
      gap: 0;
      min-width: 260px;
      max-width: 320px;
      max-height: 80vh;
      overflow-y: auto;
      overflow-x: hidden;
      background: #fff;
      border: 0.5px solid var(--border);
      border-radius: 0;
      box-shadow: 0 10px 40px rgba(21, 101, 192, 0.2);
      padding: 0.5rem 0.3rem;
    }
    .column-filter-panel .cfp-section {
      flex-shrink: 0;
      margin-bottom: 0.5rem;
    }
    .column-filter-panel .cfp-section:last-child { margin-bottom: 0; display: flex; flex-direction: column; min-height: 140px; }
    .column-filter-panel .cfp-section-title {
      font-weight: 700;
      font-size: 0.65rem;
      letter-spacing: 0.08em;
      color: var(--muted);
      margin: 0 0 0.3rem 0;
      text-transform: uppercase;
    }
    .column-filter-panel .cfp-sort-opts {
      padding-left: 0.35rem;
    }
    .column-filter-panel .cfp-sort-opt {
      display: block;
      width: 100%;
      text-align: left;
      border: none;
      background: transparent;
      color: var(--text);
      padding: 0.25rem 0;
      font: inherit;
      font-size: 0.82rem;
      cursor: pointer;
      margin: 0;
    }
    .column-filter-panel .cfp-sort-opt:hover { background: rgba(21,101,192,0.08); }
    .column-filter-panel .cfp-sort-opt.cfp-active {
      font-weight: 600;
      color: var(--accent);
    }
    .column-filter-panel .cfp-sort-opt.cfp-active::before {
      content: '';
      display: inline-block;
      width: 4px;
      height: 4px;
      border-radius: 50%;
      background: var(--accent-2);
      margin-right: 0.3rem;
      vertical-align: 0.12em;
    }
    .column-filter-panel .cfp-clear-sort,
    .column-filter-panel .cfp-clear-filter {
      margin-top: 0.15rem; margin-left: 0.25rem; font-size: 0.7rem; background: none; border: none; color: var(--accent); cursor: pointer; padding: 0;
    }
    .column-filter-panel .cfp-clear-sort:hover,
    .column-filter-panel .cfp-clear-filter:hover { text-decoration: underline; }
    .column-filter-panel .cfp-condition-select {
      width: 100%;
      padding: 0.1rem 0 0 0.1rem;
      font: inherit;
      font-family: 'Montserrat', system-ui, sans-serif;
      font-size: 0.8rem;
      background: rgba(255, 255, 255, 0.98);
      border: 1px solid var(--border);
      border-radius: 1px;
      color: var(--text);
      min-height: 25px;
      cursor: pointer;
      box-sizing: border-box;
      appearance: none;
      background-image: url(data:image/svg+xml,%3Csvg xmlns='http://www.w3.org/2000/svg' width='10' height='10' viewBox='0 0 12 12'%3E%3Cpath fill='%23f1f5f9' d='M6 8L1 3h10z'/%3E%3C/svg%3E);
      background-repeat: no-repeat;
      background-position: right 0.35rem center;
    }
    .column-filter-panel .cfp-condition-select:focus {
      outline: none;
      border-color: var(--accent);
      box-shadow: 0 0 0 3px rgba(21, 101, 192, 0.2);
    }
    .column-filter-panel .cfp-condition-inputs { margin-top: 0.2rem; }
    .column-filter-panel .cfp-condition-inputs input {
      width: 100%;
      padding: 0.2rem 0.2rem;
      font: inherit;
      font-family: 'Montserrat', system-ui, sans-serif;
      font-size: 0.8rem;
      background: rgba(255, 255, 255, 0.98);
      border: 1px solid var(--border);
      border-radius: 1px;
      color: var(--text);
      min-height: 36px;
      margin-top: 0.15rem;
      box-sizing: border-box;
    }
    .column-filter-panel .cfp-condition-inputs input:focus {
      outline: none;
      border-color: var(--accent);
      box-shadow: 0 0 0 3px rgba(21, 101, 192, 0.2);
    }
    .column-filter-panel .cfp-fbv-actions {
      display: flex;
      flex-wrap: wrap;
      gap: 0.22rem;
      margin-bottom: 0.25rem;
    }
    .column-filter-panel .cfp-fbv-actions button {
      padding: 0.2rem 0.35rem;
      font: inherit;
      font-size: 0.74rem;
      border: 1px solid rgba(255,255,255,0.15);
      background: #fff;
      color: var(--text);
      border-radius: 5px;
      cursor: pointer;
    }
    .column-filter-panel .cfp-fbv-actions button:hover { background: rgba(21,101,192,0.08); }
    .column-filter-panel .cfp-footer {
      display: flex;
      justify-content: flex-end;
      gap: 0.5rem;
      margin-top: 0;
      padding-top: 0;
      border-top: 1px solid rgba(255,255,255,0.06);
      flex-shrink: 0;
    }
    .column-filter-panel .cfp-footer button {
      padding: 0.2rem 0.35rem;
      font: inherit;
      font-size: 0.74rem;
      border: 1px solid rgba(255,255,255,0.15);
      background: #fff;
      color: var(--text);
      border-radius: 5px;
      cursor: pointer;
    }
    .column-filter-panel .cfp-footer button:hover { background: rgba(21,101,192,0.08); }
    .column-filter-panel .cfp-footer .cfp-ok { background: var(--accent); color: #fff; border-color: var(--accent); }
    .column-filter-panel .cfp-footer .cfp-ok:hover { background: var(--accent-hover); border-color: var(--accent-hover); }
    .column-filter-panel .cfp-fbv-search {
      width: 100%;
      padding: 0;
      margin-bottom: 0.2rem;
      font: inherit;
      font-family: 'Montserrat', system-ui, sans-serif;
      font-size: 0.8rem;
      background: rgba(255, 255, 255, 0.98);
      border: 1px solid var(--border);
      border-radius: 1px;
      color: var(--text);
      min-height: 25px;
      box-sizing: border-box;
    }
    .column-filter-panel .cfp-fbv-search:focus {
      outline: none;
      border-color: var(--accent);
      box-shadow: 0 0 0 3px rgba(21, 101, 192, 0.2);
    }
    .column-filter-panel .cfp-fbv-list {
      min-height: 72px;
      max-height: 160px;
      overflow-y: auto;
      overflow-x: hidden;
      border: 1px solid var(--border);
      border-radius: 5px;
      padding: 0.15rem;
      background: #fff;
    }
    .column-filter-panel .cfp-fbv-row {
      display: flex;
      align-items: center;
      gap: 0.28rem;
      padding: 0.15rem 0.22rem;
      cursor: pointer;
      color: var(--text);
      font-size: 0.78rem;
    }
    .column-filter-panel .cfp-fbv-row:hover { background: rgba(21,101,192,0.06); }
    .column-filter-panel .cfp-fbv-row input { margin: 0; }

    /* ========== MOBILE ONLY (max-width: 767px). Desktop/computer layout unchanged. ========== */
    @media (max-width: 767px) {
      .wrap {
        padding: 0.1rem 0 0.1rem;
      }
      h1 {
        font-size: 1.35rem;
      }
      .sub {
        font-size: 0.9rem;
        margin-bottom: 1.25rem;
      }
      .query-card,
      .results-card {
        width: 100%;
        margin-left: 0;
        margin-right: 0;
      }
      .form-row {
        grid-template-columns: 1fr 1fr;
        grid-template-rows: auto auto auto auto;
        grid-auto-flow: column;
        row-gap: 0.2rem;
        column-gap: 0.3rem;
      }
      .form-row .field:nth-child(1) {
        grid-column: 1;
        grid-row: 1;
        min-width: 0;
      }
      .form-row .field:nth-child(2) {
        grid-column: 1;
        grid-row: 2;
        min-width: 0;
        align-items: flex-start;
      }
      .form-row .field:nth-child(3) {
        grid-column: 1;
        grid-row: 3;
        min-width: 0;
      }
      .form-row .field:nth-child(4) {
        grid-column: 2;
        grid-row: 1;
        min-width: 0;
      }
      .form-row .field:nth-child(5) {
        grid-column: 2;
        grid-row: 2;
        min-width: 0;
      }
      .form-row .field:nth-child(6) {
        grid-column: 2;
        grid-row: 3;
        min-width: 0;
      }
      .form-row .field {
        align-items: flex-start;
      }
      .form-row .field label {
        text-align: left;
      }
      .form-row .field > label {
        justify-content: flex-start;
      }
      .form-row .choice-group {
        min-width: 0;
        padding-left: 0;
        padding-right: 0.25rem;
        gap: 0.35rem;
        flex-wrap: nowrap;
      }
      .form-row .field:nth-child(3) .choice-group {
        padding-right: 0;
      }
      .form-row .choice-option span {
        font-size: 0.82rem;
      }
      .field.submit-field {
        grid-column: 2;
        grid-row: 4;
        justify-self: end;
        align-self: start;
        align-items: flex-end;
      }
      .field.submit-field .btn {
        width: auto;
        max-width: 7rem;
        min-height: 22px;
        font-size: 0.88rem;
        padding: 0.1rem 0.65rem;
      }
      .field.submit-field .count {
        text-align: right;
        margin-top: 0;
      }
      .field input:not([type="radio"]),
      .field select {
        min-height: 0;
        font-size: 15px;
      }
      #amount {
        width: 100%;
        max-width: none;
        text-align: left;
      }
      .combo input {
        min-height: 48px;
        font-size: 0.72rem;
      }
      .combo-menu {
        min-width: 0;
        max-width: min(22rem, 95vw);
        max-height: 50vh;
      }
      .table-scroll-inner {
        max-height: 60vh;
        -webkit-overflow-scrolling: touch;
      }
      .table-wrap {
        --sticky-col1-width: 10ch;
        --sticky-col2-width: 8ch;
        --sticky-col3-width: 3.25ch;
      }
      #results-table col.sticky-col-1 { width: var(--sticky-col1-width); }
      #results-table col.sticky-col-2 { width: var(--sticky-col2-width); }
      #results-table col.sticky-col-3 { width: var(--sticky-col3-width); }
      table {
        font-size: 0.72rem;
      }
      th, td {
        padding: 0.1rem 0.2rem;
        min-height: 2.2em;
        height: auto;
      }
      th {
        font-size: 0.64rem;
      }
      #results-table thead th:first-child {
        width: var(--sticky-col1-width);
        min-width: var(--sticky-col1-width);
        max-width: var(--sticky-col1-width);
      }
      #results-table thead th:nth-child(2) {
        left: var(--sticky-col1-width);
        width: var(--sticky-col2-width);
        min-width: var(--sticky-col2-width);
        max-width: var(--sticky-col2-width);
      }
      #results-table thead th:nth-child(3) {
        left: calc(var(--sticky-col1-width) + var(--sticky-col2-width));
        width: var(--sticky-col3-width);
        min-width: var(--sticky-col3-width);
        max-width: var(--sticky-col3-width);
      }
      #results-table td.bank-name-cell {
        width: var(--sticky-col1-width);
        min-width: var(--sticky-col1-width);
        max-width: var(--sticky-col1-width);
      }
      #results-table td.sector-name-cell {
        left: var(--sticky-col1-width);
        width: var(--sticky-col2-width);
        min-width: var(--sticky-col2-width);
        max-width: var(--sticky-col2-width);
      }
      #results-table td.offer-checkbox-cell {
        left: calc(var(--sticky-col1-width) + var(--sticky-col2-width));
        width: var(--sticky-col3-width);
        min-width: var(--sticky-col3-width);
        max-width: var(--sticky-col3-width);
      }
      .results-head {
        flex-direction: column;
        align-items: stretch;
        gap: 0.5rem;
      }
      .listed-popup-backdrop {
        padding: 0.5rem;
        align-items: flex-start;
        overflow-y: auto;
      }
      .listed-popup {
        width: min(640px, 96vw);
        max-width: 100%;
        max-height: 85vh;
        padding: 0.85rem;
        box-sizing: border-box;
        overflow-x: hidden;
      }
      .listed-popup-head {
        flex-wrap: wrap;
        gap: 0.5rem;
      }
      .listed-popup-title {
        word-break: break-word;
        overflow-wrap: break-word;
        flex: 1 1 auto;
        min-width: 0;
        font-size: 0.95rem;
      }
      .listed-popup-meta {
        font-size: 0.8rem;
      }
      .details-sections {
        min-width: 0;
      }
      .details-section {
        min-width: 0;
        padding: 0.5rem 0.6rem;
        overflow-wrap: break-word;
        word-wrap: break-word;
      }
      .details-section-title {
        font-size: 0.78rem;
      }
      .details-section-list {
        overflow-wrap: break-word;
        word-wrap: break-word;
      }
      .details-section-list li {
        white-space: normal;
        word-break: break-word;
        overflow-wrap: break-word;
        line-height: 1.4;
      }
      .details-section-empty {
        white-space: normal;
        word-break: break-word;
        overflow-wrap: break-word;
      }
      .listed-popup-search {
        max-width: none;
      }
      .column-filter-panel,
      .column-filter-dropdown,
      .filter-by-values-panel {
        max-width: min(320px, 92vw);
      }
      .th-info-popover {
        max-width: min(280px, 90vw);
      }
    }
  </style>
</head>
<body>
  <!-- INJECT_SHARED -->
  <div class="wrap">

    <div class="card query-card">
      <form id="query-form" class="form-row">
        <div class="field">
          <label for="gender-male">Gender<span class="th-info-icon field-info-icon" aria-label="Info" data-tooltip="1. Up to ~0.5% lower interest for female students (selected banks).&#10;2. Preferential rates by gender (M/F/B – see Interest rate column)."><svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><circle cx="12" cy="12" r="10"/><path d="M12 16v-4M12 8h.01"/></svg></span></label>
          <div class="choice-group" role="radiogroup" aria-label="Gender">
            <label class="choice-option" for="gender-male">
              <input type="radio" id="gender-male" name="gender" value="Male">
              <span>Male</span>
            </label>
            <label class="choice-option" for="gender-female">
              <input type="radio" id="gender-female" name="gender" value="Female" checked>
              <span>Female</span>
            </label>
          </div>
        </div>
        <div class="field">
          <label for="amount">Loan amount (₹)<span class="th-info-icon field-info-icon" aria-label="Info" data-tooltip="Loans above ₹7.5 lakhs typically require security."><svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><circle cx="12" cy="12" r="10"/><path d="M12 16v-4M12 8h.01"/></svg></span></label>
          <input type="text" id="amount" name="amount" inputmode="numeric" maxlength="14" value="7000000" placeholder="e.g. 70,00,000" autocomplete="off" data-raw-max="99999999">
        </div>
        <div class="field">
          <label for="secured-yes">Loan type<span class="th-info-icon field-info-icon" aria-label="Info" data-tooltip="1. Loans above ₹7.5 lakhs typically require security.&#10;2. Secured loans have ~1.5%–2% lower interest than unsecured."><svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><circle cx="12" cy="12" r="10"/><path d="M12 16v-4M12 8h.01"/></svg></span></label>
          <div class="choice-group" role="radiogroup" aria-label="Loan type">
            <label class="choice-option" for="secured-yes">
              <input type="radio" id="secured-yes" name="secured" value="true" checked>
              <span>Secured</span>
            </label>
            <label class="choice-option" for="secured-no">
              <input type="radio" id="secured-no" name="secured" value="false">
              <span>Unsecured</span>
            </label>
          </div>
        </div>
        <div class="field">
          <label for="country">Country<span class="th-info-icon field-info-icon" aria-label="Info" data-tooltip="Some lenders offer country and university specific rates. Enter both for accurate results."><svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><circle cx="12" cy="12" r="10"/><path d="M12 16v-4M12 8h.01"/></svg></span></label>
          <div class="combo" id="country-combo">
            <input id="country" name="country" placeholder="Select or search" autocomplete="off">
            <button type="button" class="combo-clear" id="country-clear" aria-label="Clear country">x</button>
            <button type="button" class="combo-toggle" id="country-toggle" aria-label="Show country options">▼</button>
            <div class="combo-menu" id="country-menu"></div>
          </div>
        </div>
        <div class="field">
          <label for="university">University<span class="th-info-icon field-info-icon" aria-label="Info" data-tooltip="Some lenders offer country and university specific rates. Enter both for accurate results."><svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><circle cx="12" cy="12" r="10"/><path d="M12 16v-4M12 8h.01"/></svg></span></label>
          <div class="combo" id="university-combo">
            <input id="university" name="university" placeholder="Select or search" autocomplete="off">
            <button type="button" class="combo-clear" id="university-clear" aria-label="Clear university">x</button>
            <button type="button" class="combo-toggle" id="university-toggle" aria-label="Show university options">▼</button>
            <div class="combo-menu" id="university-menu"></div>
          </div>
          <p id="institutes-hint" class="query-summary muted" style="display:none; margin:0.25rem 0 0 0; font-size:0.8rem;">Open this page from the server (e.g. <code>http://localhost:3080</code> after running <code>npm start</code>) to load countries and universities.</p>
        </div>
        <div class="field">
          <label for="levelOfStudy">Level of study<span class="th-info-icon field-info-icon" aria-label="Info" data-tooltip="Level of study (e.g. Postgraduate, Undergraduate). Affects course and preferred university."><svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><circle cx="12" cy="12" r="10"/><path d="M12 16v-4M12 8h.01"/></svg></span></label>
          <div class="combo" id="level-combo">
            <input id="levelOfStudy" name="levelOfStudy" placeholder="Select or search" autocomplete="off">
            <button type="button" class="combo-clear" id="level-clear" aria-label="Clear level of study">x</button>
            <button type="button" class="combo-toggle" id="level-toggle" aria-label="Show level options">▼</button>
            <div class="combo-menu" id="level-menu"></div>
          </div>
        </div>
        <div class="field submit-field">
          <button type="submit" class="btn" id="run-btn">Submit</button>
          <span class="count" id="count">Run a query to see results.</span>
        </div>
      </form>
    </div>

    <div id="error-zone"></div>

    <div class="card results-card">
      <p class="query-summary muted" id="query-summary" aria-live="polite"></p>
      <div class="table-wrap">
        <div class="table-scroll-inner">
        <table id="results-table">
          <colgroup>
            <col class="sticky-col-1">
            <col class="sticky-col-2">
            <col class="sticky-col-3">
          </colgroup>
          <thead id="results-thead">
            <tr><th>Lender</th><th>Sector</th></tr>
          </thead>
          <tbody id="results-body">
            <tr><td colspan="2" class="empty">No results yet. Set criteria and click Run query.</td></tr>
          </tbody>
        </table>
        </div>
      </div>
    </div>
  </div>

  <script>
    const form = document.getElementById('query-form');
    const runBtn = document.getElementById('run-btn');
    const resultsBody = document.getElementById('results-body');
    const countEl = document.getElementById('count');
    const errorZone = document.getElementById('error-zone');
    const querySummary = document.getElementById('query-summary');

    const thead = document.getElementById('results-thead');
    let sharedBankData = window.SHARED_BANK_DATA || null;
    let institutesList = [];
    let listedPopupBackdrop = null;
    let listedPopupState = { bankName: '', criteria: '', mode: 'criteria', search: '' };
    let detailsPopupBackdrop = null;
    let viewDetailsData = null;
    let lenderDetailsMap = new Map();
    let autoRunTimer = null;
    let queryRunCounter = 0;
    const ENABLE_DIFF_HIGHLIGHT = true;
    const ENABLE_STABLE_RESULTS_ORDER = true;
    let previousRenderSnapshot = null;
    const lenderStableOrder = new Map();
    const FALLBACK_LENDER_ORDER_BASE = 100000;
    let lenderStableOrderCounter = FALLBACK_LENDER_ORDER_BASE;
    const bankManifestOrderBySlug = new Map();
    let columnFilterState = {};
    let columnSortState = {};
    let filterByValuesDraft = null;
    let columnFilterDropdownEl = null;
    let filterByValuesPanelEl = null;
    let headerInfoPopoverEl = null;
    let fieldLabelPopoverCloseTimeout = null;
    let lastRenderedRows = [];
    let lastRenderParams = null;
    let countryOptions = [];
    let universityOptions = [];
    const levelOptions = [
      'Any',
      'Postgraduate (Degree / Diploma)',
      'Undergraduate (Degree / Diploma)',
      'Doctrate courses',
      'Professional or Technical courses',
      'Executive courses'
    ];
    const NOT_IN_LIST_COUNTRY = 'Not in the list';
    const NOT_IN_LIST_UNIVERSITY = 'Not in the list';
    const UNIVERSITY_PLACEHOLDER_DEFAULT = 'Select or search';
    const UNIVERSITY_PLACEHOLDER_COUNTRY_NOT_LISTED = 'Search by university';

    /** Indian comma style: 1,23,45,678 (2-2-2-3 from left). Max 8 digits. */
    function formatIndianAmount(str) {
      const digits = String(str).replace(/\D/g, '').slice(0, 8);
      if (digits.length === 0) return '';
      if (digits.length <= 3) return digits;
      let result = digits.slice(-3);
      let s = digits.slice(0, -3);
      while (s.length > 0) {
        result = s.slice(-2) + ',' + result;
        s = s.slice(0, -2);
      }
      return result;
    }

    function setAmountDisplay(value) {
      const el = form.amount;
      if (!el) return;
      const digits = String(value).replace(/\D/g, '').slice(0, 8);
      el.value = formatIndianAmount(digits);
    }

    function bindAmountInput() {
      const el = form.amount;
      if (!el) return;
      el.addEventListener('input', function () {
        const start = this.selectionStart;
        const oldValue = this.value;
        const digitsBefore = (oldValue.slice(0, start).match(/\d/g) || []).length;
        const digits = oldValue.replace(/\D/g, '').slice(0, 8);
        const formatted = formatIndianAmount(digits);
        this.value = formatted;
        let newPos = 0;
        let count = 0;
        for (let i = 0; i < formatted.length && count < digitsBefore; i++) {
          if (/\d/.test(formatted[i])) count++;
          newPos = i + 1;
        }
        this.setSelectionRange(newPos, newPos);
      });
      setAmountDisplay(el.value);
    }

    function showError(msg) {
      errorZone.innerHTML = msg ? `<div class="error">${msg}</div>` : '';
    }

    function normalizeText(value) {
      return value != null ? String(value).trim().toLowerCase() : '';
    }

    function isInstituteChangesEnabled(inst) {
      if (!inst || typeof inst !== 'object') return false;
      const value = inst.changes;
      if (value === true) return true;
      if (typeof value === 'string') {
        const normalized = value.trim().toLowerCase();
        return normalized === 'true' || normalized === 'yes';
      }
      return false;
    }

    function normalizeLenderKey(value) {
      return String(value || '')
        .toLowerCase()
        .replace(/&/g, ' and ')
        .replace(/[^a-z0-9]/g, '');
    }

    function normalizeSlug(value) {
      return String(value || '').trim().toLowerCase();
    }

    function toDisplayValue(value) {
      const text = value != null ? String(value).trim() : '';
      return text || 'N/A';
    }

    function getDetailsForLender(lenderName) {
      if (!lenderName || !lenderDetailsMap || !lenderDetailsMap.size) return null;
      const key = normalizeLenderKey(lenderName);
      return lenderDetailsMap.get(key) || null;
    }

    function buildLenderDetailsMap(detailsData) {
      lenderDetailsMap = new Map();
      const records = detailsData && Array.isArray(detailsData.records) ? detailsData.records : [];
      for (const record of records) {
        const lender = record && record.lender != null ? String(record.lender).trim() : '';
        if (!lender) continue;
        lenderDetailsMap.set(normalizeLenderKey(lender), record.details || {});
      }
    }

    function sanitizeCriteriaLabel(criteria, country) {
      const cleanCriteria = criteria != null ? String(criteria).trim() : '';
      if (!cleanCriteria) return '';
      const criteriaNorm = normalizeText(cleanCriteria);
      const countryNorm = normalizeText(country);
      if (countryNorm && criteriaNorm === countryNorm) return '';
      return cleanCriteria;
    }

    function getBankCriteriaUniversityMap(bankName) {
      const target = normalizeText(bankName);
      const grouped = {};
      if (!target) return grouped;
      for (const row of (institutesList || [])) {
        if (normalizeText(row.lenderName) !== target) continue;
        const criteria = sanitizeCriteriaLabel(row.criteria, row.country);
        if (!criteria) continue;
        const univ = row.university ? String(row.university).trim() : '';
        if (!univ) continue;
        if (!grouped[criteria]) grouped[criteria] = [];
        grouped[criteria].push(univ);
      }
      const normalized = {};
      Object.keys(grouped).forEach((criteria) => {
        normalized[criteria] = [...new Set(grouped[criteria])].sort((a, b) => a.localeCompare(b));
      });
      return normalized;
    }

    function resolveCriteriaKeys(criteriaKeys, wantedCriteria) {
      const cleanWanted = wantedCriteria != null ? String(wantedCriteria).trim() : '';
      if (!cleanWanted) return [];
      const wantedNorm = normalizeText(cleanWanted);
      const direct = criteriaKeys.filter((key) => normalizeText(key) === wantedNorm);

      const parts = cleanWanted
        .split(/\s*\/\s*|\s*\|\s*|\s+or\s+/i)
        .map((x) => x.trim())
        .filter(Boolean);
      const partNorms = parts.map((x) => normalizeText(x));

      const matched = criteriaKeys.filter((key) => {
        const keyNorm = normalizeText(key);
        if (!keyNorm) return false;
        if (wantedNorm.includes(keyNorm) || keyNorm.includes(wantedNorm)) return true;
        return partNorms.some((part) => part && (keyNorm === part || keyNorm.includes(part) || part.includes(keyNorm)));
      });

      return [...new Set([...(direct || []), ...(matched || [])])];
    }

    function getAudienceLabel(genderValue) {
      const g = normalizeText(genderValue);
      if (g === 'equal') return 'B';
      if (g === 'male') return 'M';
      if (g === 'female') return 'F';
      return 'N/A';
    }
    function getAudienceTooltip(audience) {
      const a = (audience || '').toUpperCase();
      if (a === 'B') return 'For both, Male & Female';
      if (a === 'M') return 'Male only';
      if (a === 'F') return 'Female only';
      return '';
    }

    function getInterestRateNumber(rateValue) {
      if (rateValue == null) return NaN;
      const parsed = Number(rateValue);
      return Number.isFinite(parsed) ? parsed : NaN;
    }

    function ensureListedPopup() {
      if (listedPopupBackdrop) return listedPopupBackdrop;
      listedPopupBackdrop = document.createElement('div');
      listedPopupBackdrop.id = 'listed-popup-backdrop';
      listedPopupBackdrop.className = 'listed-popup-backdrop';
      listedPopupBackdrop.innerHTML = [
        '<div class="listed-popup" role="dialog" aria-modal="true" aria-label="Bank universities list">',
        '  <div class="listed-popup-head">',
        '    <h3 id="listed-popup-title" class="listed-popup-title">Listed Universities</h3>',
        '    <button type="button" class="listed-popup-close" data-close-listed-popup="1">Close</button>',
        '  </div>',
        '  <p id="listed-popup-meta" class="listed-popup-meta"></p>',
        '  <div class="listed-popup-tools">',
        '    <input id="listed-popup-search" class="listed-popup-search" type="text" placeholder="Search university..." autocomplete="off" />',
        '    <button type="button" class="listed-popup-switch" data-listed-mode-toggle="1">Show Bank-level List</button>',
        '  </div>',
        '  <ul id="listed-popup-list" class="listed-popup-list"></ul>',
        '</div>'
      ].join('');
      document.body.appendChild(listedPopupBackdrop);
      return listedPopupBackdrop;
    }

    function closeListedPopup() {
      const popup = ensureListedPopup();
      popup.style.display = 'none';
    }

    function renderListedPopupContent(bankName, criteria, mode) {
      const popup = ensureListedPopup();
      const title = popup.querySelector('#listed-popup-title');
      const meta = popup.querySelector('#listed-popup-meta');
      const switchBtn = popup.querySelector('[data-listed-mode-toggle]');
      const searchInput = popup.querySelector('#listed-popup-search');
      const listEl = popup.querySelector('#listed-popup-list');
      const byCriteria = getBankCriteriaUniversityMap(bankName);
      const criteriaKeys = Object.keys(byCriteria).sort((a, b) => a.localeCompare(b));
      const wantedCriteria = criteria && String(criteria).trim() ? String(criteria).trim() : '';
      const searchQuery = normalizeText(listedPopupState.search || '');
      if (searchInput && searchInput.value !== (listedPopupState.search || '')) {
        searchInput.value = listedPopupState.search || '';
      }

      title.textContent = bankName ? ('Listed Universities - ' + bankName) : 'Listed Universities';

      if (mode === 'bank') {
        switchBtn.textContent = 'Show Selected Criteria Only';
        switchBtn.style.display = wantedCriteria ? 'inline-block' : 'none';
        const filteredByCriteria = {};
        for (const key of criteriaKeys) {
          const list = (byCriteria[key] || []).filter((name) => {
            if (!searchQuery) return true;
            return normalizeText(name).includes(searchQuery);
          });
          if (list.length) filteredByCriteria[key] = list;
        }
        const filteredKeys = Object.keys(filteredByCriteria).sort((a, b) => a.localeCompare(b));
        if (!filteredKeys.length) {
          meta.textContent = 'No universities found for this bank in institutes data.';
          listEl.innerHTML = '<li>N/A</li>';
        } else {
          const total = filteredKeys.reduce((acc, key) => acc + filteredByCriteria[key].length, 0);
          const suffix = searchQuery ? (' (filtered by "' + (listedPopupState.search || '') + '")') : '';
          meta.textContent = `${total} universities across ${filteredKeys.length} criteria.${suffix}`;
          listEl.innerHTML = filteredKeys.map((key) => {
            const list = filteredByCriteria[key] || [];
            const items = list.length ? list.map((name) => '<li>' + escapeHtml(name) + '</li>').join('') : '<li>N/A</li>';
            return '<li class="listed-criteria-group">'
              + '<p class="listed-criteria-head">' + escapeHtml(key) + '</p>'
              + '<ul class="listed-popup-list">' + items + '</ul>'
              + '</li>';
          }).join('');
        }
      } else {
        switchBtn.textContent = 'Show Bank-level List';
        switchBtn.style.display = 'inline-block';
        const matchedKeys = resolveCriteriaKeys(criteriaKeys, wantedCriteria);
        const universities = [...new Set(matchedKeys.flatMap((key) => byCriteria[key] || []))]
          .filter((name) => {
            if (!searchQuery) return true;
            return normalizeText(name).includes(searchQuery);
          })
          .sort((a, b) => a.localeCompare(b));
        if (matchedKeys.length) {
          const suffix = searchQuery ? (' (filtered by "' + (listedPopupState.search || '') + '")') : '';
          const criteriaLabel = wantedCriteria || matchedKeys[0];
          meta.textContent = `${universities.length} universities for criteria: ${criteriaLabel}.${suffix}`;
          listEl.innerHTML = universities.length
            ? universities.map((name) => '<li>' + escapeHtml(name) + '</li>').join('')
            : '<li>N/A</li>';
        } else {
          meta.textContent = wantedCriteria
            ? `No universities found for criteria: ${wantedCriteria}.`
            : 'No criteria available for this offer.';
          listEl.innerHTML = '<li>N/A</li>';
        }
      }
      popup.style.display = 'flex';
    }

    function openListedPopupForBank(bankName, criteria) {
      listedPopupState = {
        bankName: bankName || '',
        criteria: criteria || '',
        mode: 'criteria',
        search: ''
      };
      renderListedPopupContent(listedPopupState.bankName, listedPopupState.criteria, listedPopupState.mode);
    }

    function ensureDetailsPopup() {
      if (detailsPopupBackdrop) return detailsPopupBackdrop;
      detailsPopupBackdrop = document.createElement('div');
      detailsPopupBackdrop.id = 'details-popup-backdrop';
      detailsPopupBackdrop.className = 'listed-popup-backdrop';
      detailsPopupBackdrop.innerHTML = [
        '<div class="listed-popup" role="dialog" aria-modal="true" aria-label="Lender details">',
        '  <div class="listed-popup-head">',
        '    <h3 id="details-popup-title" class="listed-popup-title">View Details</h3>',
        '    <button type="button" class="listed-popup-close" data-close-details-popup="1">Close</button>',
        '  </div>',
        '  <p id="details-popup-meta" class="listed-popup-meta"></p>',
        '  <div id="details-popup-content" class="details-sections"></div>',
        '</div>'
      ].join('');
      document.body.appendChild(detailsPopupBackdrop);
      return detailsPopupBackdrop;
    }

    function closeDetailsPopup() {
      const popup = ensureDetailsPopup();
      popup.style.display = 'none';
    }

    function renderDetailsSection(label, detailsObj, key) {
      const section = detailsObj && typeof detailsObj === 'object' ? detailsObj[key] : null;
      const bullets = section && Array.isArray(section.bullets) ? section.bullets.filter((x) => String(x || '').trim()) : [];
      const raw = section && section.raw != null ? String(section.raw).trim() : '';
      const listHtml = bullets.length
        ? ('<ul class="details-section-list">' + bullets.map((item) => '<li>' + escapeHtml(toDisplayValue(item)) + '</li>').join('') + '</ul>')
        : ('<p class="details-section-empty">' + escapeHtml(toDisplayValue(raw)) + '</p>');
      return '<section class="details-section">'
        + '<p class="details-section-title">' + escapeHtml(label) + '</p>'
        + listHtml
        + '</section>';
    }

    function renderDetailsPopupContent(lenderName) {
      const popup = ensureDetailsPopup();
      const title = popup.querySelector('#details-popup-title');
      const meta = popup.querySelector('#details-popup-meta');
      const content = popup.querySelector('#details-popup-content');
      const details = getDetailsForLender(lenderName) || {};
      const hasData = Object.keys(details).length > 0;

      title.textContent = 'View Details - ' + toDisplayValue(lenderName);
      meta.textContent = hasData ? 'Standardized lender-level details from uploaded matrix.' : 'No lender-level details found in uploaded matrix for this lender.';

      const sections = [
        ['Apply via', 'applyVia'],
        ['Margin', 'margin'],
        ['Interest Rate', 'interestRate'],
        ['Loan Amount Covers', 'loanAmountCovers'],
        ['Other Charges', 'otherCharges'],
        ['Security', 'security'],
        ['Course', 'course'],
        ['Others', 'others']
      ];

      content.innerHTML = sections.map(([label, key]) => renderDetailsSection(label, details, key)).join('');
      popup.style.display = 'flex';
    }

    function openDetailsPopupForLender(lenderName) {
      renderDetailsPopupContent(lenderName || 'N/A');
    }

    function fmtObj(v) {
      if (v == null) return 'N/A';
      if (typeof v === 'object') return JSON.stringify(v).replace(/^\{|\}$/g, '').replace(/"/g, '');
      return String(v);
    }
    function fmtFees(p) {
      if (!p || typeof p !== 'object') return 'N/A';
      const minVal = p.min != null ? '₹' + Number(p.min).toLocaleString('en-IN') : null;
      const maxVal = p.max != null ? (p.max === 1 ? '1%' : '₹' + Number(p.max).toLocaleString('en-IN')) : null;
      const parts = [];
      if (minVal != null) parts.push('Min: ' + minVal);
      if (maxVal != null) parts.push('Max: ' + maxVal);
      return parts.length ? parts.join(', ') : 'N/A';
    }
    function fmtEligibility(e) {
      if (!e || typeof e !== 'object') return 'N/A';
      const parts = [];
      if (e.nationality) parts.push(e.nationality);
      if (e.age && typeof e.age === 'object') parts.push('Age ' + (e.age.min ?? '') + '–' + (e.age.max ?? ''));
      if (e.qualification) parts.push(e.qualification);
      return parts.length ? parts.join(', ') : fmtObj(e);
    }

    // Columns and sources per spec: Interest Rate→interest.rate, Type→interest.type, Preferred University right of Type of Rate, Security→security.coverageDisplay (when secured), Repayment→repayment_tenure.tenure, Margin→margin, Processing fees→processing_fees.displayText, Moratorium→moratorium.periodDisplay (+ " *" when paymentDuring is Mandatory), Course→institute.json (bank+university), rest from shared/_keyTree
    function getColumns(secured, selectedUniversity, selectedCountry) {
      const universityNorm = normalizeText(selectedUniversity);
      const countryNorm = normalizeText(selectedCountry);
      const showPreferredUniversity = !!universityNorm
        && universityNorm !== normalizeText(NOT_IN_LIST_UNIVERSITY)
        && countryNorm !== normalizeText(NOT_IN_LIST_COUNTRY);
      const cols = ['Lender', 'Sector', 'Interest Rate', 'Type of Rate'];
      if (showPreferredUniversity) cols.push('Preferred University');
      if (secured) cols.push('Security coverage %');
      cols.push('Repayment Tenure', 'Margin (%)', 'Processing fees', 'Moratorium period', 'Course', 'Nationality', 'Age', 'Qualification', 'University strictness', 'Delayed EMI payment', 'Avg time to sanction', 'Dedicated case manager', 'Onboarding process');
      return cols;
    }

    // Display labels for column headers. Keys must match getColumns() and COLUMN_TYPE. Change values here to rename headings.
    const COLUMN_LABELS = {
      'Lender': 'Lender',
      'Sector': 'Sector',
      'Interest Rate': 'Interest rate (% p.a.)',
      'Type of Rate': 'Type of Rate',
      'Preferred University': 'Preferred University',
      'Security coverage %': 'Security coverage %',
      'Repayment Tenure': 'Repayment tenure (Max. in years)',
      'Margin (%)': 'Margin (% of loan amt.)',
      'Processing fees': 'Processing fees (% of loan amt.)',
      'Moratorium period': 'Moratorium period (Course period + Months)',
      'Course': 'Course',
      'Nationality': 'Nationality',
      'Age': 'Age (Min. in years)',
      'Qualification': 'Qualification',
      'University strictness': 'University strictness',
      'Delayed EMI payment': 'Delayed EMI payment ( per month)',
      'Avg time to sanction': 'Avg time to sanction (in B. days)',
      'Dedicated case manager': 'Dedicated case manager',
      'Onboarding process': 'Onboarding process'
    };

    // Optional tooltip text for column headers (hover + click). Add entries to show an info icon with this text.
    const COLUMN_HEADER_TOOLTIP = {
      'Interest Rate': 'Calculation Methodology - Simple interest during the moratorium period; compound interest thereafter (except Tata Capital, which uses simple interest throughout).',
      'Type of Rate': '1. Floating - Linked to floating base rate + Risk premium (depending on profile)\n2. Fixed - Linked to fixed base rate + Risk premium (depending on profile)',
      'Preferred University': 'Whether this lender has the selected university in their preferred list.',
      'Security coverage %': 'Percentage of the loan amount that must be secured (e.g. collateral).',
      'Repayment Tenure': 'Payable in Equal Monthly Installments (EMIs).',
      'Margin (%)': '1. Amount to be paid by student\'s own pocket.\n2. Scholarship/assistantship can be included\n3. To be provided yearly or at first disbursement on a pro-rata basis',
      'Processing fees': 'To process your application lenders charge processing fee. Excluding taxes.',
      'Moratorium period': 'No payment period. EMI starts after moratorium period.\n\nPayment during moratorium:\n1. Options - Payment can be in Partial Simple Interest (PSI), Simple Interest (SI) or EMI\n2. If not paid, it\'s added to principal & to be paid in EMIs after moratorium period.\n3. * Mandatory',
      'Nationality': '1. OCI – Overseas Citizen of India\n2. PIO – Person of Indian Origin\n3. NRI – Non-Resident Indian',
      'Age': 'Provable as on the date of application',
      'Qualification': 'Required qualification to be eligible',
      'Delayed EMI payment': 'For the delayed period for the default amount',
      'Avg time to sanction': 'After all the documents are submitted',
      'Dedicated case manager': 'Handles Documentation, Application, Paperwork, Disbursement & others',
      'Onboarding process': 'Application process'
    };

    const COLUMN_TYPE = {
      'Lender': 'text',
      'Sector': 'text',
      'Interest Rate': 'number',
      'Type of Rate': 'text',
      'Preferred University': 'text',
      'Security coverage %': 'number',
      'Repayment Tenure': 'number',
      'Margin (%)': 'number',
      'Processing fees': 'number',
      'Moratorium period': 'number',
      'Course': 'text',
      'Nationality': 'text',
      'Age': 'text',
      'Qualification': 'text',
      'University strictness': 'text',
      'Delayed EMI payment': 'text',
      'Avg time to sanction': 'number',
      'Dedicated case manager': 'text',
      'Onboarding process': 'text'
    };
    function getColumnType(columnKey) {
      return COLUMN_TYPE[columnKey] || 'text';
    }

    function getCellValueForColumn(row, columnKey, dataColumns, secured, selectedUniversity, institutesList, levelOfStudy, includePreferredUniversity) {
      if (columnKey === 'Lender') return row.bankName != null ? String(row.bankName).trim() : '';
      if (columnKey === 'Sector') return row.sector != null ? String(row.sector).trim() : '';
      const idx = dataColumns.indexOf(columnKey);
      if (idx < 0) return '';
      const cells = getOfferCells(row, secured, selectedUniversity, institutesList, levelOfStudy, includePreferredUniversity);
      const cell = cells[idx];
      if (cell == null) return '';
      if (typeof cell === 'object' && cell.kind === 'interestAudience') {
        return Number.isFinite(cell.rateNumber) ? cell.rateNumber : (cell.rateText || '');
      }
      if (typeof cell === 'object' && cell.kind === 'listedUniversityOnly') {
        return cell.label || 'Listed Only';
      }
      return cell;
    }

    function getCellDisplayForFilterValues(cellValue) {
      const s = cellValue != null ? String(cellValue).trim() : '';
      return s === '' ? '(Blanks)' : s;
    }

    function getFirstNumberOfRange(str) {
      if (str == null || typeof str !== 'string') return NaN;
      const s = str.trim();
      const dash = s.indexOf('-');
      if (dash > 0) {
        const first = parseFloat(s.slice(0, dash).trim(), 10);
        return Number.isFinite(first) ? first : NaN;
      }
      const n = parseFloat(s, 10);
      return Number.isFinite(n) ? n : NaN;
    }
    function getFirstNumberFromLeft(str) {
      if (str == null || typeof str !== 'string') return NaN;
      const m = String(str).trim().match(/\d+/);
      if (!m) return NaN;
      const n = parseFloat(m[0], 10);
      return Number.isFinite(n) ? n : NaN;
    }
    function getFirstFullNumberFromLeft(str) {
      if (str == null || typeof str !== 'string') return NaN;
      const s = String(str).trim();
      const m = s.match(/[\d,]+\.?\d*|\.\d+/);
      if (!m) return NaN;
      const numStr = m[0].replace(/,/g, '');
      const n = parseFloat(numStr, 10);
      return Number.isFinite(n) ? n : NaN;
    }
    function getCellComparableForSort(cellValue, columnKey) {
      if (columnKey === 'Avg time to sanction') {
        const str = String(cellValue != null ? cellValue : '').trim();
        const firstNum = getFirstNumberOfRange(str);
        return Number.isFinite(firstNum) ? firstNum : (str || '');
      }
      if (columnKey === 'Security coverage %') {
        const str = String(cellValue != null ? cellValue : '').trim();
        const firstNum = getFirstNumberFromLeft(str);
        return Number.isFinite(firstNum) ? firstNum : (str || '');
      }
      if (columnKey === 'Repayment Tenure') {
        const str = String(cellValue != null ? cellValue : '').trim();
        const firstNum = getFirstNumberFromLeft(str);
        return Number.isFinite(firstNum) ? firstNum : (str || '');
      }
      if (columnKey === 'Margin (%)') {
        const str = String(cellValue != null ? cellValue : '').trim();
        const firstNum = getFirstNumberFromLeft(str);
        return Number.isFinite(firstNum) ? firstNum : (str || '');
      }
      if (columnKey === 'Moratorium period') {
        const str = String(cellValue != null ? cellValue : '').trim();
        const firstNum = getFirstNumberFromLeft(str);
        return Number.isFinite(firstNum) ? firstNum : (str || '');
      }
      if (columnKey === 'Processing fees') {
        const str = String(cellValue != null ? cellValue : '').trim();
        const firstNum = getFirstFullNumberFromLeft(str);
        return Number.isFinite(firstNum) ? firstNum : (str || '');
      }
      const type = getColumnType(columnKey);
      if (type === 'number') {
        const n = Number(cellValue);
        return Number.isFinite(n) ? n : (String(cellValue != null ? cellValue : '').trim() || '');
      }
      return String(cellValue != null ? cellValue : '').trim().toLowerCase();
    }

    const SORT_FILTER_ICON = '<span class="th-sort-filter-icon" aria-label="Sort or filter" title="Sort or filter"><svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><path d="M3 6h18M7 12h10M10 18h4"/></svg></span>';
    const INFO_ICON_SVG = '<svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><circle cx="12" cy="12" r="10"/><path d="M12 16v-4M12 8h.01"/></svg>';
    function thWithIcon(label, columnKey) {
      const key = columnKey != null ? columnKey : label;
      const displayLabel = (COLUMN_LABELS[key] != null ? COLUMN_LABELS[key] : key);
      const hasSortOrFilter = !!(columnFilterState[key] || columnSortState[key]);
      const activeClass = hasSortOrFilter ? ' th-sort-filter-icon--active' : '';
      const icon = '<span class="th-sort-filter-icon' + activeClass + '" aria-label="Sort or filter" title="' + (hasSortOrFilter ? 'Filter applied' : 'Sort or filter') + '"><svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><path d="M3 6h18M7 12h10M10 18h4"/></svg></span>';
      const tooltipText = COLUMN_HEADER_TOOLTIP[key] != null ? COLUMN_HEADER_TOOLTIP[key] : (displayLabel || key);
      const infoIconHtml = '<span class="th-info-icon" aria-label="Info" title="' + escapeHtml(tooltipText) + '" data-column-tooltip="' + escapeHtml(tooltipText) + '">' + INFO_ICON_SVG + '</span>';
      const iconsRow = '<span class="th-head-icons">' + infoIconHtml + icon + '</span>';
      let labelHtml = escapeHtml(displayLabel);
      const parenIdx = displayLabel.indexOf(' (');
      if (parenIdx !== -1) {
        labelHtml = escapeHtml(displayLabel.slice(0, parenIdx)) + '<br>' + escapeHtml(displayLabel.slice(parenIdx + 1));
      }
      const thClass = hasSortOrFilter ? ' class="header-has-sort-or-filter"' : '';
      return '<th' + thClass + ' data-column-key="' + escapeHtml(key) + '"><span class="th-head th-head-clickable"><span class="th-head-label">' + labelHtml + '</span>' + iconsRow + '</span></th>';
    }
    function buildHeaderRow(cols) {
      const firstTwo = cols.slice(0, 2).map(function(c) { return thWithIcon(c, c); }).join('');
      const checkboxTh = '<th class="offer-checkbox-header" data-column-key="OfferSelect"><span class="th-head"><input type="checkbox" class="select-all-offers" aria-label="Select all offers" title="Select all offers"></span></th>';
      const rest = cols.slice(2).map(function(c) { return thWithIcon(c, c); }).join('');
      return '<tr>' + firstTwo + checkboxTh + rest + '</tr>';
    }
    // Initial header (secured = true, with Security coverage column)
    (function initTable() {
      const cols = getColumns(true, '', '');
      thead.innerHTML = buildHeaderRow(cols);
      const empty = document.querySelector('#results-body .empty');
      if (empty) empty.setAttribute('colspan', String(cols.length + 1));
    })();

    function getCountryScopeLabel(offer) {
      const scope = offer && typeof offer === 'object' ? offer.countryScope : null;
      if (!scope || typeof scope !== 'object') return '';
      const mode = String(scope.mode || '').trim().toLowerCase();
      if (mode !== 'only' && mode !== 'exclude') return '';
      if (scope.label != null && String(scope.label).trim()) return String(scope.label).trim();
      const countries = Array.isArray(scope.countries)
        ? scope.countries.map((c) => String(c || '').trim()).filter(Boolean)
        : [];
      if (!countries.length) return mode === 'only' ? 'Country restricted' : 'Country exclusions';
      return mode === 'only'
        ? (countries.join(', ') + ' only')
        : ('All except ' + countries.join(', '));
    }

    function getOfferExactKey(row) {
      const slug = row && row.bankSlug != null ? String(row.bankSlug).trim() : '';
      const offerIndex = row && row.offer && row.offer._index != null ? String(row.offer._index).trim() : '';
      if (slug && offerIndex) return slug + '::' + offerIndex;
      return '';
    }

    function normalizeKeyPart(value) {
      return String(value == null ? '' : value).trim().toLowerCase();
    }

    function getOfferCompareGroupKey(row) {
      const offer = row && row.offer ? row.offer : {};
      const institute = offer && offer.institute ? offer.institute : {};
      const amount = offer && offer.loan && offer.loan.amount ? offer.loan.amount : {};
      const lenderKey = normalizeKeyPart(row && (row.bankSlug || row.bankName));
      const amountMin = normalizeKeyPart(amount.min);
      const amountMax = normalizeKeyPart(amount.max);
      const instituteChanges = normalizeKeyPart(institute.changes);
      const instituteCriteria = normalizeKeyPart(institute.criteria);
      const levelOfStudy = normalizeKeyPart(institute.level_of_study);
      const course = normalizeKeyPart(offer.course);
      const rateType = normalizeKeyPart(offer && offer.interest ? offer.interest.type : '');
      return [
        lenderKey,
        amountMin,
        amountMax,
        instituteChanges,
        instituteCriteria,
        levelOfStudy,
        course,
        rateType
      ].join('::');
    }

    function cellComparableValue(cell) {
      if (cell == null) return 'N/A';
      if (typeof cell === 'object') {
        if (cell.kind === 'interestAudience') {
          return [cell.rate || 'N/A', cell.audience || 'N/A', cell.rateText || ''].join(' | ');
        }
        if (cell.kind === 'listedUniversityOnly') {
          return [cell.label || 'Listed Only', cell.bankName || '', cell.criteria || ''].join(' | ');
        }
        try {
          return JSON.stringify(cell);
        } catch {
          return String(cell);
        }
      }
      return String(cell);
    }

    function getStableOfferIndex(row) {
      const offerIndex = row && row.offer && row.offer._index != null ? Number(row.offer._index) : NaN;
      if (Number.isFinite(offerIndex)) return offerIndex;
      return Number.MAX_SAFE_INTEGER;
    }

    function getStableLoanMin(row) {
      const minVal = row && row.offer && row.offer.loan && row.offer.loan.amount ? Number(row.offer.loan.amount.min) : NaN;
      if (Number.isFinite(minVal)) return minVal;
      return Number.MAX_SAFE_INTEGER;
    }

    function compareRowsForStableOrder(a, b) {
      const lenderA = normalizeText(a && a.bankName);
      const lenderB = normalizeText(b && b.bankName);
      const orderA = lenderStableOrder.has(lenderA) ? lenderStableOrder.get(lenderA) : Number.MAX_SAFE_INTEGER;
      const orderB = lenderStableOrder.has(lenderB) ? lenderStableOrder.get(lenderB) : Number.MAX_SAFE_INTEGER;
      if (orderA !== orderB) return orderA - orderB;

      const lenderCmp = lenderA.localeCompare(lenderB);
      if (lenderCmp !== 0) return lenderCmp;

      const idxA = getStableOfferIndex(a);
      const idxB = getStableOfferIndex(b);
      if (idxA !== idxB) return idxA - idxB;

      const loanMinA = getStableLoanMin(a);
      const loanMinB = getStableLoanMin(b);
      if (loanMinA !== loanMinB) return loanMinA - loanMinB;

      const typeA = normalizeText(a && a.offer && a.offer.interest ? a.offer.interest.type : '');
      const typeB = normalizeText(b && b.offer && b.offer.interest ? b.offer.interest.type : '');
      const typeCmp = typeA.localeCompare(typeB);
      if (typeCmp !== 0) return typeCmp;

      const rateA = a && a.offer && a.offer.interest ? Number(a.offer.interest.rate) : NaN;
      const rateB = b && b.offer && b.offer.interest ? Number(b.offer.interest.rate) : NaN;
      if (Number.isFinite(rateA) && Number.isFinite(rateB) && rateA !== rateB) return rateA - rateB;

      return 0;
    }

    function fmtAge(ageObj) {
      if (ageObj == null) return 'N/A';
      if (typeof ageObj === 'string') return ageObj.trim() || 'N/A';
      if (typeof ageObj !== 'object') return 'N/A';
      const min = ageObj.min;
      const max = ageObj.max;
      if (min == null && max == null) return 'N/A';
      if (Number(max) === 99) return (min != null ? String(min) : '') + '+';
      if (min != null && max != null) return min + '–' + max;
      if (min != null) return String(min);
      if (max != null) return String(max);
      return 'N/A';
    }

    function normalizeUniversityText(value) {
      return String(value || '')
        .toLowerCase()
        .replace(/[^a-z0-9\s]/g, ' ')
        .replace(/\s+/g, ' ')
        .trim();
    }

    function universityTextMatches(queryText, candidateText) {
      const query = normalizeUniversityText(queryText);
      const candidate = normalizeUniversityText(candidateText);
      if (!query || !candidate) return false;
      return candidate.includes(query) || query.includes(candidate);
    }

    /** Delayed EMI payment: use display when present (new model), else legacy min–max or primitive. */
    function fmtDelayedEmiPayment(v) {
      if (v == null) return 'N/A';
      if (typeof v === 'string' || typeof v === 'number') return String(v).trim() || 'N/A';
      if (typeof v !== 'object') return 'N/A';
      if (v.display != null && String(v.display).trim()) return String(v.display).trim();
      const min = v.min;
      const max = v.max;
      if (min == null && max == null) return 'N/A';
      if (min != null && max != null) return String(min) + '–' + String(max);
      if (min != null) return String(min);
      if (max != null) return String(max);
      return 'N/A';
    }

    const SHARED_COL_COUNT = 8; // Nationality, Age, Qualification, University strictness, Delayed EMI, Avg time, Dedicated case manager, Onboarding (after offer cols)
    function sharedCells(shared, offer) {
      const def = () => Array(SHARED_COL_COUNT).fill('N/A');
      if (!shared || typeof shared !== 'object') return def();
      const nationality = shared.nationality ?? shared.eligibility?.nationality;
      const ageObj = shared.age || shared.eligibility?.age;
      const qual = shared.qualification ?? shared.eligibility?.qualification;
      const univStrict = shared.universityStrictness ?? shared.eligibility?.universityStrictness;
      const delayedEmi = shared.delayed_emi_payment;
      const delayedEmiDisplay = delayedEmi && typeof delayedEmi === 'object' && delayedEmi.displayText != null ? String(delayedEmi.displayText).trim() : (typeof delayedEmi === 'string' ? delayedEmi : 'N/A');
      const avgTime = shared.Average_Time_To_Sanction;
      const avgTimeStr = avgTime != null && typeof avgTime === 'object' && (avgTime.min != null || avgTime.max != null) ? (avgTime.min ?? '') + (avgTime.min != null && avgTime.max != null ? '–' : '') + (avgTime.max ?? '') : (avgTime != null ? String(avgTime) : 'N/A');
      return [
        nationality ?? 'N/A',
        fmtAge(ageObj),
        qual ?? 'N/A',
        univStrict ?? 'N/A',
        delayedEmiDisplay,
        avgTimeStr,
        shared.dedicatedCaseManager != null ? (shared.dedicatedCaseManager ? 'Yes' : 'No') : 'N/A',
        (shared.onboarding_process ?? 'N/A')
      ];
    }

    /** Return array of cell values for one offer (no bank name). Course: when Level=Any or University=Not in list use offer.course; else use institutes.json. */
    function getOfferCells(row, secured, selectedUniversity, institutesList, levelOfStudy, includePreferredUniversity) {
      const o = row.offer;
      const shared = row.shared || null;
      const coverageStr = (ox) => (ox?.security?.coverageDisplay != null ? String(ox.security.coverageDisplay) : 'N/A');
      const tenureVal = o.repayment_tenure != null && typeof o.repayment_tenure === 'object' ? (o.repayment_tenure.tenure ?? 'N/A') : (o.repayment_tenure ?? 'N/A');
      const processingVal = o.processing_fees != null && typeof o.processing_fees === 'object' ? (o.processing_fees.displayText ?? 'N/A') : 'N/A';
      const moratorium = o.moratorium;
      const periodBase = moratorium != null && typeof moratorium === 'object' ? (moratorium.periodDisplay ?? 'N/A') : 'N/A';
      const paymentDuring = moratorium != null && typeof moratorium === 'object' ? (moratorium.paymentDuring ?? '') : '';
      const periodDisplay = (periodBase || 'N/A') + (String(paymentDuring).trim() === 'Mandatory' ? ' *' : '');
      const instituteChanges = o && o.institute ? o.institute.changes : null;
      const isInstituteWiseChanges = isInstituteChangesEnabled(o && o.institute ? o.institute : null);
      const instituteCriteria = o && o.institute && o.institute.criteria != null ? String(o.institute.criteria).trim() : '';
      let preferredUniversity = 'N/A';
      const selectedUniversityNorm = normalizeText(selectedUniversity);
      const isUniversitySelected = !!selectedUniversityNorm;
      const isUniversityNotInListSelected = selectedUniversityNorm === normalizeText(NOT_IN_LIST_UNIVERSITY);
      const lenderHasSelectedUniversity = isUniversitySelected && !isUniversityNotInListSelected
        ? (institutesList || []).some((i) => normalizeText(i.lenderName) === normalizeText(row.bankName) && universityTextMatches(selectedUniversity, i.university || ''))
        : false;

      if (isUniversitySelected) {
        if (isUniversityNotInListSelected) {
          preferredUniversity = 'No';
        } else if (isInstituteWiseChanges && lenderHasSelectedUniversity) {
          preferredUniversity = {
            kind: 'listedUniversityOnly',
            label: 'Listed (Check list)',
            bankName: row.bankName,
            criteria: instituteCriteria
          };
        } else {
          preferredUniversity = 'No';
        }
      } else if (isInstituteWiseChanges) {
        preferredUniversity = {
          kind: 'listedUniversityOnly',
          label: instituteCriteria ? ('Listed Only - ' + instituteCriteria) : 'Listed Only',
          bankName: row.bankName,
          criteria: instituteCriteria
        };
      } else {
        preferredUniversity = 'Open to All';
      }
      // Course source rule:
      // - Preferred University = Yes -> institutes.json course
      // - Preferred University = No / Not in list -> bank JSON offer.course
      const normalizedUniversity = selectedUniversity != null ? String(selectedUniversity).trim().toLowerCase() : '';
      const isUniversityNotInList = !normalizedUniversity || normalizedUniversity === normalizeText(NOT_IN_LIST_UNIVERSITY);
      const isPreferredUniversity = preferredUniversity === 'Yes';
      const courseValue = (!isUniversityNotInList && isPreferredUniversity)
        ? 'N/A'
        : (o.course ?? 'N/A');
      const rateLabel = o.interest?.rate != null ? o.interest.rate : 'N/A';
      const rateNumber = getInterestRateNumber(o.interest?.rate);
      const audienceLabel = getAudienceLabel(o.gender);
      let cells = [
        {
          kind: 'interestAudience',
          rate: rateLabel,
          audience: audienceLabel,
          rateNumber,
          rateText: rateLabel
        },
        o.interest?.type ?? 'N/A'
      ];
      if (includePreferredUniversity) cells.push(preferredUniversity);
      if (secured) cells.push(coverageStr(o));
      const marginValue = (o.margin != null && Number(o.margin) === 99) ? 'N/A' : (o.margin ?? 'N/A');
      cells.push(tenureVal, marginValue, processingVal, periodDisplay, courseValue);
      cells = cells.concat(sharedCells(shared, o));
      return cells;
    }

    function hasActiveFilterOrSort() {
      if (Object.keys(columnSortState).some(function(k) { return columnSortState[k]; })) return true;
      return Object.keys(columnFilterState).some(function(k) { return columnFilterState[k]; });
    }

    function getNumericForFilter(raw, columnKey) {
      const comparable = getCellComparableForSort(raw, columnKey);
      if (typeof comparable === 'number' && Number.isFinite(comparable)) return comparable;
      const n = Number(raw);
      return Number.isFinite(n) ? n : NaN;
    }
    function rowMatchesCondition(row, columnKey, filterSpec, dataColumns, secured, selectedUniversity, institutesList, levelOfStudy, includePreferredUniversity) {
      const raw = getCellValueForColumn(row, columnKey, dataColumns, secured, selectedUniversity, institutesList, levelOfStudy, includePreferredUniversity);
      const displayStr = getCellDisplayForFilterValues(raw);
      const str = String(raw != null ? raw : '').trim();
      const strLower = str.toLowerCase();
      const num = getNumericForFilter(raw, columnKey);
      const isNum = Number.isFinite(num);
      const colType = getColumnType(columnKey);
      const op = filterSpec.operator;
      const val = filterSpec.value;
      const val2 = filterSpec.value2;
      if (op === 'none') return true;
      if (op === 'is_empty') return str === '';
      if (op === 'is_not_empty') return str !== '';
      if (op === 'text_contains') return strLower.includes(String(val || '').toLowerCase());
      if (op === 'text_does_not_contain') return !strLower.includes(String(val || '').toLowerCase());
      if (op === 'text_starts_with') return strLower.startsWith(String(val || '').toLowerCase());
      if (op === 'text_ends_with') return strLower.endsWith(String(val || '').toLowerCase());
      if (op === 'text_is_exactly') return str === String(val != null ? val : '').trim();
      if (op === 'greater_than') return isNum && num > Number(val);
      if (op === 'greater_than_or_equal') return isNum && num >= Number(val);
      if (op === 'less_than') return isNum && num < Number(val);
      if (op === 'less_than_or_equal') return isNum && num <= Number(val);
      if (op === 'is_equal_to') return colType === 'number' ? (isNum && num === Number(val)) : (str === String(val != null ? val : '').trim());
      if (op === 'is_not_equal_to') return colType === 'number' ? (!isNum || num !== Number(val)) : (str !== String(val != null ? val : '').trim());
      if (op === 'is_between') return isNum && num >= Number(val) && num <= Number(val2);
      if (op === 'is_not_between') return isNum && (num < Number(val) || num > Number(val2));
      return true;
    }

    function applyFilters(rows, cols, dataColumns, secured, selectedUniversity, levelOfStudy, selectedCountry, exceptColumnKey) {
      let out = rows;
      const includePreferredUniversity = !!normalizeText(selectedUniversity) && normalizeText(selectedUniversity) !== normalizeText(NOT_IN_LIST_UNIVERSITY) && normalizeText(selectedCountry) !== normalizeText(NOT_IN_LIST_COUNTRY);
      cols.forEach(function(columnKey) {
        if (exceptColumnKey && columnKey === exceptColumnKey) return;
        const spec = columnFilterState[columnKey];
        if (!spec) return;
        if (spec.type === 'condition' && spec.condition) {
          out = out.filter(function(row) {
            return rowMatchesCondition(row, columnKey, spec.condition, dataColumns, secured, selectedUniversity, institutesList, levelOfStudy, includePreferredUniversity);
          });
        } else if (spec.type === 'values') {
          if (!Array.isArray(spec.selectedValues) || spec.selectedValues.length === 0) {
            out = [];
          } else {
            out = out.filter(function(row) {
              const raw = getCellValueForColumn(row, columnKey, dataColumns, secured, selectedUniversity, institutesList, levelOfStudy, includePreferredUniversity);
              const displayStr = getCellDisplayForFilterValues(raw);
              return spec.selectedValues.indexOf(displayStr) !== -1;
            });
          }
        }
      });
      return out;
    }

    function applySort(rows, cols, dataColumns, secured, selectedUniversity, levelOfStudy, selectedCountry) {
      const sortColumn = Object.keys(columnSortState).find(function(k) { return columnSortState[k] && columnSortState[k].direction; });
      if (!sortColumn || !columnSortState[sortColumn].direction) return rows;
      const direction = columnSortState[sortColumn].direction;
      const includePreferredUniversity = !!normalizeText(selectedUniversity) && normalizeText(selectedUniversity) !== normalizeText(NOT_IN_LIST_UNIVERSITY) && normalizeText(selectedCountry) !== normalizeText(NOT_IN_LIST_COUNTRY);
      return rows.slice().sort(function(a, b) {
        const va = getCellComparableForSort(getCellValueForColumn(a, sortColumn, dataColumns, secured, selectedUniversity, institutesList, levelOfStudy, includePreferredUniversity), sortColumn);
        const vb = getCellComparableForSort(getCellValueForColumn(b, sortColumn, dataColumns, secured, selectedUniversity, institutesList, levelOfStudy, includePreferredUniversity), sortColumn);
        let cmp = 0;
        if (typeof va === 'number' && typeof vb === 'number') cmp = va - vb;
        else cmp = String(va).localeCompare(String(vb), undefined, { sensitivity: 'base' });
        return direction === 'desc' ? -cmp : cmp;
      });
    }

    function renderRowsFlat(flatRows, secured, selectedUniversity, levelOfStudy, selectedCountry) {
      const selectedUniversityNorm = normalizeText(selectedUniversity);
      const selectedCountryNorm = normalizeText(selectedCountry);
      const includePreferredUniversity = !!selectedUniversityNorm && selectedUniversityNorm !== normalizeText(NOT_IN_LIST_UNIVERSITY) && selectedCountryNorm !== normalizeText(NOT_IN_LIST_COUNTRY);
      const cols = getColumns(secured, selectedUniversity, selectedCountry);
      const dataColumns = cols.slice(2);
      const colCount = cols.length + 1;
      thead.innerHTML = buildHeaderRow(cols);
      if (!flatRows.length) {
        countEl.textContent = '0 matches.';
        resultsBody.innerHTML = '<tr><td colspan="' + colCount + '" class="empty">No banks with matching offers for this criteria.</td></tr>';
        previousRenderSnapshot = { byExactKey: new Map(), byGroupKey: new Map() };
        return;
      }
      const flatBankCount = new Set(flatRows.map(function(r) { return r.bankName || ''; })).size;
      countEl.innerHTML = '<strong>' + flatRows.length + '</strong> offer' + (flatRows.length === 1 ? '' : 's') + ' from <strong>' + flatBankCount + '</strong> bank' + (flatBankCount === 1 ? '' : 's') + '.';
      const canDiffWithPrevious = ENABLE_DIFF_HIGHLIGHT && !!previousRenderSnapshot;
      const currentSnapshotEntries = [];
      const tableRows = flatRows.map(function(row, rowIdx) {
        const bankName = row.bankName || '';
        const sector = row.sector != null ? String(row.sector).trim() : 'N/A';
        const prevBank = rowIdx > 0 ? (flatRows[rowIdx - 1].bankName || '') : '';
        const nextBank = rowIdx < flatRows.length - 1 ? (flatRows[rowIdx + 1].bankName || '') : '';
        const isFirstInBank = bankName !== prevBank;
        const isLastInBank = bankName !== nextBank;
        let trClass = ' bank-block';
        if (isFirstInBank) trClass += ' bank-group-first';
        if (isLastInBank) trClass += ' bank-group-last';
        const cells = getOfferCells(row, secured, selectedUniversity, institutesList, levelOfStudy, includePreferredUniversity);
        const comparableCells = cells.map(cellComparableValue);
        const comparableByColumn = {};
        dataColumns.forEach(function(col, idx) { comparableByColumn[col] = comparableCells[idx]; });
        currentSnapshotEntries.push({ exactKey: getOfferExactKey(row), groupKey: getOfferCompareGroupKey(row), comparableCells: comparableCells, comparableByColumn: comparableByColumn });
        const tds = cells.map(function(cell, cellIdx) {
          const columnName = dataColumns[cellIdx];
          const dataCol = ' data-column-key="' + escapeHtml(columnName) + '"';
          const cls = typeof cell === 'number' ? 'num' : '';
          if (cell && typeof cell === 'object' && cell.kind === 'interestAudience') {
            const rate = escapeHtml(cell.rate || 'N/A');
            const audience = escapeHtml(cell.audience || 'N/A');
            const audienceTooltip = getAudienceTooltip(cell.audience);
            const sortValue = Number.isFinite(cell.rateNumber) ? String(cell.rateNumber) : '';
            const searchValue = [cell.rateText || '', cell.audience || ''].join(' ').trim();
            const badgeTitle = audienceTooltip ? ' title="' + escapeHtml(audienceTooltip) + '"' : '';
            const badgeDataTooltip = audienceTooltip ? ' data-audience-tooltip="' + escapeHtml(audienceTooltip) + '"' : '';
            return '<td class="' + [cls, 'interest-rate-cell'].filter(Boolean).join(' ') + '"' + dataCol + ' data-rate-number="' + escapeHtml(sortValue) + '" data-rate-text="' + escapeHtml(searchValue) + '"><span class="audience-rate"><span>' + rate + '</span><span class="audience-badge"' + badgeTitle + badgeDataTooltip + '>' + audience + '</span></span></td>';
          }
          if (cell && typeof cell === 'object' && cell.kind === 'listedUniversityOnly') {
            const label = escapeHtml(cell.label || 'Listed Only');
            const bank = escapeHtml(cell.bankName || bankName || '');
            const criteria = escapeHtml(cell.criteria || '');
            return '<td class="' + cls + '"' + dataCol + '><button type="button" class="listed-universities-trigger" data-listed-bank="' + bank + '" data-listed-criteria="' + criteria + '">' + label + '</button></td>';
          }
          return '<td class="' + cls + '"' + dataCol + '>' + (cell != null ? escapeHtml(String(cell)) : 'N/A') + '</td>';
        });
        const checkboxTd = '<td class="offer-checkbox-cell"><input type="checkbox" class="offer-checkbox" aria-label="Select offer"></td>';
        return '<tr class="' + trClass.trim() + '"><td class="bank-name-cell"><span class="lender-name">' + escapeHtml(bankName) + '</span><button type="button" class="view-details-trigger" data-details-bank="' + escapeHtml(bankName) + '">View Details</button></td><td class="sector-name-cell">' + escapeHtml(sector) + '</td>' + checkboxTd + tds.join('') + '</tr>';
      });
      resultsBody.innerHTML = tableRows.join('');
      const byExactKey = new Map();
      const byGroupKey = new Map();
      currentSnapshotEntries.forEach(function(entry, idx) {
        const stored = { entryId: idx, exactKey: entry.exactKey, groupKey: entry.groupKey, comparableCells: entry.comparableCells, comparableByColumn: entry.comparableByColumn };
        if (entry.exactKey) byExactKey.set(entry.exactKey, stored);
        if (entry.groupKey) {
          if (!byGroupKey.has(entry.groupKey)) byGroupKey.set(entry.groupKey, []);
          byGroupKey.get(entry.groupKey).push(stored);
        }
      });
      previousRenderSnapshot = { byExactKey: byExactKey, byGroupKey: byGroupKey };
      bindColumnFilterDropdown();
    }

    const FILTER_OPERATORS = [
      { id: 'none', label: 'None', inputKind: 'none' },
      { id: 'is_empty', label: 'Is empty', inputKind: 'none' },
      { id: 'is_not_empty', label: 'Is not empty', inputKind: 'none' },
      { id: 'text_contains', label: 'Text contains', inputKind: 'text' },
      { id: 'text_does_not_contain', label: 'Text does not contain', inputKind: 'text' },
      { id: 'text_starts_with', label: 'Text starts with', inputKind: 'text' },
      { id: 'text_ends_with', label: 'Text ends with', inputKind: 'text' },
      { id: 'text_is_exactly', label: 'Text is exactly', inputKind: 'text' },
      { id: 'greater_than', label: 'Greater than', inputKind: 'number' },
      { id: 'greater_than_or_equal', label: 'Greater than or equal to', inputKind: 'number' },
      { id: 'less_than', label: 'Less than', inputKind: 'number' },
      { id: 'less_than_or_equal', label: 'Less than or equal to', inputKind: 'number' },
      { id: 'is_equal_to', label: 'Is equal to', inputKind: 'typeAware' },
      { id: 'is_not_equal_to', label: 'Is not equal to', inputKind: 'typeAware' },
      { id: 'is_between', label: 'Is between', inputKind: 'numberRange' },
      { id: 'is_not_between', label: 'Is not between', inputKind: 'numberRange' }
    ];
    function getOperatorsForColumn(columnKey) {
      const colType = getColumnType(columnKey);
      return FILTER_OPERATORS.filter(function(op) {
        if (op.inputKind === 'none') return true;
        if (op.id.startsWith('text_')) return colType === 'text';
        if (['greater_than', 'greater_than_or_equal', 'less_than', 'less_than_or_equal', 'is_between', 'is_not_between'].indexOf(op.id) !== -1) return colType === 'number';
        if (op.inputKind === 'typeAware') return true;
        return true;
      });
    }

    function ensureColumnFilterDropdown() {
      if (columnFilterDropdownEl) return columnFilterDropdownEl;
      columnFilterDropdownEl = document.createElement('div');
      columnFilterDropdownEl.className = 'column-filter-dropdown';
      columnFilterDropdownEl.setAttribute('role', 'menu');
      document.body.appendChild(columnFilterDropdownEl);
      return columnFilterDropdownEl;
    }

    function ensureFilterByValuesPanel() {
      if (filterByValuesPanelEl) return filterByValuesPanelEl;
      filterByValuesPanelEl = document.createElement('div');
      filterByValuesPanelEl.className = 'filter-by-values-panel';
      document.body.appendChild(filterByValuesPanelEl);
      return filterByValuesPanelEl;
    }

    function openColumnFilterPanel(columnKey, thEl) {
      closeColumnFilterDropdown();
      const panel = ensureFilterByValuesPanel();
      if (!lastRenderParams) return;
      const colType = getColumnType(columnKey);
      const sortAscLabel = colType === 'number' ? 'Sort A to Z / Smallest to Largest' : 'Sort A to Z / Smallest to Largest';
      const sortDescLabel = colType === 'number' ? 'Sort Z to A / Largest to Smallest' : 'Sort Z to A / Largest to Smallest';
      const sortState = columnSortState[columnKey];
      const filterState = columnFilterState[columnKey];
      const operators = getOperatorsForColumn(columnKey);
      const currentCondition = filterState && filterState.type === 'condition' && filterState.condition ? filterState.condition : { operator: 'none', value: '', value2: '' };
      const operatorsOptions = operators.map(function(op) {
        const sel = op.id === currentCondition.operator ? ' selected' : '';
        return '<option value="' + escapeHtml(op.id) + '"' + sel + '>' + escapeHtml(op.label) + '</option>';
      }).join('');
      var hasSort = sortState && sortState.direction;
      var hasFilter = filterState && (filterState.type === 'condition' || filterState.type === 'values');
      panel.className = 'filter-by-values-panel column-filter-panel';
      panel.innerHTML =
        '<div class="cfp-column-label">Filter column: ' + escapeHtml(columnKey) + '</div>' +
        '<div class="cfp-section">' +
          '<div class="cfp-section-title">Sort</div>' +
          '<div class="cfp-sort-opts">' +
            '<button type="button" class="cfp-sort-opt" data-dir="asc">' + escapeHtml(sortAscLabel) + '</button>' +
            '<button type="button" class="cfp-sort-opt" data-dir="desc">' + escapeHtml(sortDescLabel) + '</button>' +
            (hasSort ? '<button type="button" class="cfp-clear-sort">Clear sort</button>' : '') +
          '</div>' +
        '</div>' +
        '<div class="cfp-section">' +
          '<div class="cfp-section-title">Filter by condition</div>' +
          '<select class="cfp-condition-select">' + operatorsOptions + '</select>' +
          '<div class="cfp-condition-inputs"></div>' +
          (hasFilter ? '<button type="button" class="cfp-clear-filter">Clear filter</button>' : '') +
        '</div>' +
        '<div class="cfp-section">' +
          '<div class="cfp-section-title">Filter by values</div>' +
          '<div class="cfp-fbv-actions">' +
            '<button type="button" class="cfp-fbv-select-all">Select all</button>' +
            '<button type="button" class="cfp-fbv-clear">Clear all</button>' +
          '</div>' +
          '<input type="text" class="cfp-fbv-search" placeholder="Search values..." autocomplete="off"/>' +
          '<div class="cfp-fbv-list"></div>' +
        '</div>' +
        '<div class="cfp-footer">' +
          '<button type="button" class="cfp-cancel">Cancel</button>' +
          '<button type="button" class="cfp-ok">OK</button>' +
        '</div>';
      panel.dataset.columnKey = columnKey;
      function getThForColumn(key) {
        var thead = document.getElementById('results-thead');
        if (!thead) return null;
        var headers = thead.querySelectorAll('th[data-column-key]');
        for (var i = 0; i < headers.length; i++) {
          if (headers[i].getAttribute('data-column-key') === key) return headers[i];
        }
        return null;
      }
      var sortOpts = panel.querySelectorAll('.cfp-sort-opt');
      sortOpts.forEach(function(btn) {
        if (sortState && sortState.direction === btn.dataset.dir) btn.classList.add('cfp-active');
        btn.onclick = function() {
          if (sortState && sortState.direction === btn.dataset.dir) {
            delete columnSortState[columnKey];
          } else {
            columnSortState = {};
            columnSortState[columnKey] = { direction: btn.dataset.dir };
          }
          panel.classList.remove('is-open');
          if (lastRenderParams) renderRows(lastRenderedRows, lastRenderParams.secured, lastRenderParams.selectedUniversity, lastRenderParams.levelOfStudy, lastRenderParams.selectedCountry);
        };
      });
      var condSelect = panel.querySelector('.cfp-condition-select');
      var condInputs = panel.querySelector('.cfp-condition-inputs');
      function renderConditionInputs(opId) {
        var op = FILTER_OPERATORS.find(function(o) { return o.id === opId; });
        if (!op || op.inputKind === 'none') { condInputs.innerHTML = ''; return; }
        var kind = op.inputKind;
        var ph = kind === 'text' ? 'Enter text' : (kind === 'typeAware' ? (getColumnType(columnKey) === 'number' ? 'Enter value' : 'Enter text') : 'Enter value');
        var existing = columnFilterState[columnKey] && columnFilterState[columnKey].condition;
        var val = (existing && existing.operator === opId && existing.value != null) ? existing.value : '';
        var val2 = (existing && existing.operator === opId && existing.value2 != null) ? existing.value2 : '';
        var inputType = (kind === 'number' || kind === 'numberRange') ? 'number' : 'text';
        if (kind === 'numberRange') {
          condInputs.innerHTML = '<input type="number" class="cfp-cond-value" placeholder="From" value="' + escapeHtml(val) + '"/><input type="number" class="cfp-cond-value2" placeholder="To" value="' + escapeHtml(val2) + '"/>';
        } else {
          condInputs.innerHTML = '<input type="' + inputType + '" class="cfp-cond-value" placeholder="' + escapeHtml(ph) + '" value="' + escapeHtml(val) + '"/>';
        }
      }
      renderConditionInputs(condSelect.value);
      condSelect.onchange = function() { renderConditionInputs(condSelect.value); };
      var clearSortBtn = panel.querySelector('.cfp-clear-sort');
      if (clearSortBtn) {
        clearSortBtn.onclick = function() {
          delete columnSortState[columnKey];
          panel.classList.remove('is-open');
          if (lastRenderParams) renderRows(lastRenderedRows, lastRenderParams.secured, lastRenderParams.selectedUniversity, lastRenderParams.levelOfStudy, lastRenderParams.selectedCountry);
        };
      }
      var clearFilterBtn = panel.querySelector('.cfp-clear-filter');
      if (clearFilterBtn) {
        clearFilterBtn.onclick = function() {
          delete columnFilterState[columnKey];
          if (lastRenderParams) renderRows(lastRenderedRows, lastRenderParams.secured, lastRenderParams.selectedUniversity, lastRenderParams.levelOfStudy, lastRenderParams.selectedCountry);
          requestAnimationFrame(function() {
            var th = getThForColumn(columnKey);
            if (th) openColumnFilterPanel(columnKey, th); else panel.classList.remove('is-open');
          });
        };
      }
      function applyCondition() {
        var opId = condSelect.value;
        var op = FILTER_OPERATORS.find(function(o) { return o.id === opId; });
        if (!op || opId === 'none') { delete columnFilterState[columnKey]; return; }
        var valEl = condInputs.querySelector('.cfp-cond-value');
        var val2El = condInputs.querySelector('.cfp-cond-value2');
        var value = valEl ? valEl.value : '';
        var value2 = val2El ? val2El.value : '';
        columnFilterState[columnKey] = { type: 'condition', condition: { operator: opId, value: value, value2: value2 } };
      }
      var includePreferredUniversity = !!normalizeText(lastRenderParams.selectedUniversity) && normalizeText(lastRenderParams.selectedUniversity) !== normalizeText(NOT_IN_LIST_UNIVERSITY) && normalizeText(lastRenderParams.selectedCountry) !== normalizeText(NOT_IN_LIST_COUNTRY);
      var cols = getColumns(lastRenderParams.secured, lastRenderParams.selectedUniversity, lastRenderParams.selectedCountry);
      var dataColumns = cols.slice(2);
      var filteredForValues = applyFilters(lastRenderedRows, cols, dataColumns, lastRenderParams.secured, lastRenderParams.selectedUniversity, lastRenderParams.levelOfStudy, lastRenderParams.selectedCountry, columnKey);
      var rowsToUse = hasActiveFilterOrSort() ? applySort(filteredForValues, cols, dataColumns, lastRenderParams.secured, lastRenderParams.selectedUniversity, lastRenderParams.levelOfStudy, lastRenderParams.selectedCountry) : filteredForValues;
      var uniqueValues = [];
      var seen = {};
      rowsToUse.forEach(function(row) {
        var raw = getCellValueForColumn(row, columnKey, dataColumns, lastRenderParams.secured, lastRenderParams.selectedUniversity, institutesList, lastRenderParams.levelOfStudy, includePreferredUniversity);
        var displayStr = getCellDisplayForFilterValues(raw);
        if (!seen[displayStr]) { seen[displayStr] = true; uniqueValues.push(displayStr); }
      });
      uniqueValues.sort(function(a, b) {
        if (a === '(Blanks)') return 1;
        if (b === '(Blanks)') return -1;
        return a.localeCompare(b, undefined, { sensitivity: 'base' });
      });
      var applied = (filterState && filterState.type === 'values' && filterState.selectedValues) ? filterState.selectedValues.slice() : uniqueValues.slice();
      filterByValuesDraft = { columnKey: columnKey, selectedValues: applied.slice(), allValues: uniqueValues };
      var listEl = panel.querySelector('.cfp-fbv-list');
      listEl.innerHTML = uniqueValues.map(function(v) {
        var checked = applied.indexOf(v) !== -1 ? ' checked' : '';
        return '<label class="cfp-fbv-row"><input type="checkbox" data-value="' + escapeHtml(v) + '"' + checked + '/><span>' + escapeHtml(v) + '</span></label>';
      }).join('');
      function updateDisplaying() {
        var chks = listEl.querySelectorAll('input:checked');
        filterByValuesDraft.selectedValues = Array.from(chks).map(function(c) { return c.dataset.value; });
      }
      listEl.querySelectorAll('input').forEach(function(cb) { cb.onchange = updateDisplaying; });
      panel.querySelector('.cfp-fbv-select-all').onclick = function() {
        listEl.querySelectorAll('input').forEach(function(c) { c.checked = true; });
        updateDisplaying();
      };
      panel.querySelector('.cfp-fbv-clear').onclick = function() {
        listEl.querySelectorAll('input').forEach(function(c) { c.checked = false; });
        updateDisplaying();
      };
      panel.querySelector('.cfp-fbv-search').oninput = function() {
        var q = (this.value || '').toLowerCase();
        listEl.querySelectorAll('.cfp-fbv-row').forEach(function(row) {
          var text = (row.textContent || '').toLowerCase();
          row.style.display = q && !text.includes(q) ? 'none' : '';
        });
      };
      panel.querySelector('.cfp-cancel').onclick = function() {
        panel.classList.remove('is-open');
        filterByValuesDraft = null;
      };
      panel.querySelector('.cfp-ok').onclick = function() {
        applyCondition();
        var chks = listEl.querySelectorAll('input:checked');
        var selected = Array.from(chks).map(function(c) { return c.dataset.value; });
        var allVals = filterByValuesDraft ? filterByValuesDraft.allValues : [];
        if (allVals.length > 0) {
          if (selected.length === 0) {
            delete columnFilterState[columnKey];
          } else if (selected.length < allVals.length || !selected.every(function(v) { return allVals.indexOf(v) !== -1; })) {
            columnFilterState[columnKey] = { type: 'values', selectedValues: selected };
          }
        }
        panel.classList.remove('is-open');
        filterByValuesDraft = null;
        if (lastRenderParams) renderRows(lastRenderedRows, lastRenderParams.secured, lastRenderParams.selectedUniversity, lastRenderParams.levelOfStudy, lastRenderParams.selectedCountry);
      };
      var anchorTh = getThForColumn(columnKey);
      if (anchorTh) {
        thEl = anchorTh;
        anchorTh.scrollIntoView({ block: 'nearest', inline: 'nearest', behavior: 'auto' });
      }
      var rect = thEl.getBoundingClientRect();
      panel.classList.add('is-open');
      var panelRect = panel.getBoundingClientRect();
      var vw = window.innerWidth || document.documentElement.clientWidth;
      var vh = window.innerHeight || document.documentElement.clientHeight;
      var gap = 4;
      var topBelow = rect.bottom + gap;
      var topAbove = rect.top - panelRect.height - gap;
      if (topBelow + panelRect.height <= vh - 8) {
        panel.style.top = topBelow + 'px';
      } else if (topAbove >= 8) {
        panel.style.top = topAbove + 'px';
      } else {
        panel.style.top = Math.max(8, Math.min(topBelow, vh - panelRect.height - 8)) + 'px';
      }
      var leftUnderColumn = Math.max(8, Math.min(rect.left, vw - panelRect.width - 8));
      panel.style.left = leftUnderColumn + 'px';
    }

    function ensureHeaderInfoPopover() {
      if (headerInfoPopoverEl) return headerInfoPopoverEl;
      headerInfoPopoverEl = document.createElement('div');
      headerInfoPopoverEl.className = 'th-info-popover';
      headerInfoPopoverEl.setAttribute('role', 'tooltip');
      document.body.appendChild(headerInfoPopoverEl);
      return headerInfoPopoverEl;
    }

    function closeHeaderInfoPopover() {
      if (headerInfoPopoverEl) headerInfoPopoverEl.classList.remove('is-open');
    }

    function openHeaderInfoPopover(text, anchorEl) {
      const popover = ensureHeaderInfoPopover();
      popover.textContent = text;
      popover.classList.add('is-open');
      const rect = anchorEl.getBoundingClientRect();
      const popoverWidth = 280;
      let left = rect.left;
      let top = rect.bottom + 6;
      if (left + popoverWidth > (window.innerWidth || document.documentElement.clientWidth)) left = Math.max(8, (window.innerWidth || document.documentElement.clientWidth) - popoverWidth - 8);
      if (left < 8) left = 8;
      if (top + 120 > (window.innerHeight || document.documentElement.clientHeight)) top = Math.max(8, rect.top - 10);
      popover.style.left = left + 'px';
      popover.style.top = top + 'px';
    }

    function bindFieldLabelInfoIcons() {
      const queryCard = document.querySelector('.query-card');
      if (!queryCard) return;
      const icons = queryCard.querySelectorAll('.field-info-icon');
      const popover = ensureHeaderInfoPopover();
      const mobile = window.matchMedia('(max-width: 991px)');

      function scheduleClose() {
        if (fieldLabelPopoverCloseTimeout) clearTimeout(fieldLabelPopoverCloseTimeout);
        fieldLabelPopoverCloseTimeout = setTimeout(function() { closeHeaderInfoPopover(); fieldLabelPopoverCloseTimeout = null; }, 150);
      }
      function cancelClose() {
        if (fieldLabelPopoverCloseTimeout) { clearTimeout(fieldLabelPopoverCloseTimeout); fieldLabelPopoverCloseTimeout = null; }
      }

      if (!popover.dataset.fieldHoverBound) {
        popover.dataset.fieldHoverBound = '1';
        popover.addEventListener('mouseenter', cancelClose);
        popover.addEventListener('mouseleave', function() { closeHeaderInfoPopover(); });
      }

      icons.forEach(function(icon) {
        const text = icon.getAttribute('data-tooltip');
        if (!text) return;

        icon.addEventListener('mouseenter', function() {
          if (mobile.matches) return;
          cancelClose();
          openHeaderInfoPopover(text, icon);
        });
        icon.addEventListener('mouseleave', function() {
          if (mobile.matches) return;
          scheduleClose();
        });

        icon.addEventListener('click', function(e) {
          if (!mobile.matches) return;
          e.preventDefault();
          e.stopPropagation();
          if (headerInfoPopoverEl && headerInfoPopoverEl.classList.contains('is-open') && headerInfoPopoverEl.textContent === text) {
            closeHeaderInfoPopover();
          } else {
            openHeaderInfoPopover(text, icon);
          }
        });
      });
    }

    function closeColumnFilterDropdown() {
      if (columnFilterDropdownEl) columnFilterDropdownEl.classList.remove('is-open');
    }

    function openColumnFilterDropdown(columnKey, thEl) {
      const dropdown = ensureColumnFilterDropdown();
      const colType = getColumnType(columnKey);
      const sortAscLabel = colType === 'number' ? 'Sort smallest to largest' : 'Sort A to Z';
      const sortDescLabel = colType === 'number' ? 'Sort largest to smallest' : 'Sort Z to A';
      const sortState = columnSortState[columnKey];
      const filterState = columnFilterState[columnKey];
      const hasSort = sortState && sortState.direction;
      const hasFilter = filterState && (filterState.type === 'condition' || filterState.type === 'values');
      let html = '<button type="button" class="cfd-item cfd-sort-asc" data-direction="asc">' + sortAscLabel + '</button><button type="button" class="cfd-item cfd-sort-desc" data-direction="desc">' + sortDescLabel + '</button><div class="cfd-divider" style="height:1px;background:rgba(255,255,255,0.06);margin:0.25rem 0;"></div><button type="button" class="cfd-item cfd-filter-condition">Filter by condition</button><button type="button" class="cfd-item cfd-filter-values">Filter by values</button>';
      if (hasSort || hasFilter) {
        html += '<div class="cfd-divider" style="height:1px;background:rgba(255,255,255,0.06);margin:0.25rem 0;"></div>';
        if (hasSort) html += '<button type="button" class="cfd-item cfd-clear-sort">Clear sort</button>';
        if (hasFilter) html += '<button type="button" class="cfd-item cfd-clear-filter">Clear filter</button>';
      }
      dropdown.innerHTML = html;
      const sortAscBtn = dropdown.querySelector('.cfd-sort-asc');
      const sortDescBtn = dropdown.querySelector('.cfd-sort-desc');
      if (sortState && sortState.direction === 'asc') sortAscBtn.classList.add('cfd-active');
      if (sortState && sortState.direction === 'desc') sortDescBtn.classList.add('cfd-active');
      if (filterState && filterState.type === 'condition') dropdown.querySelector('.cfd-filter-condition').classList.add('cfd-active');
      if (filterState && filterState.type === 'values') dropdown.querySelector('.cfd-filter-values').classList.add('cfd-active');
      var rect = thEl.getBoundingClientRect();
      dropdown.style.left = rect.left + 'px';
      dropdown.style.top = (rect.bottom + 4) + 'px';
      dropdown.classList.add('is-open');
      dropdown.dataset.columnKey = columnKey;
      var vw = window.innerWidth || document.documentElement.clientWidth;
      var vh = window.innerHeight || document.documentElement.clientHeight;
      var dropRect = dropdown.getBoundingClientRect();
      if (dropRect.right > vw) dropdown.style.left = Math.max(8, vw - dropRect.width - 8) + 'px';
      if (dropRect.left < 8) dropdown.style.left = '8px';
      if (dropRect.bottom > vh) dropdown.style.top = Math.max(8, vh - dropRect.height - 8) + 'px';
      if (dropRect.top < 8) dropdown.style.top = '8px';
      sortAscBtn.onclick = function() {
        if (sortState && sortState.direction === 'asc') {
          delete columnSortState[columnKey];
        } else {
          columnSortState = {};
          columnSortState[columnKey] = { direction: 'asc' };
        }
        closeColumnFilterDropdown();
        if (lastRenderParams) renderRows(lastRenderedRows, lastRenderParams.secured, lastRenderParams.selectedUniversity, lastRenderParams.levelOfStudy, lastRenderParams.selectedCountry);
      };
      sortDescBtn.onclick = function() {
        if (sortState && sortState.direction === 'desc') {
          delete columnSortState[columnKey];
        } else {
          columnSortState = {};
          columnSortState[columnKey] = { direction: 'desc' };
        }
        closeColumnFilterDropdown();
        if (lastRenderParams) renderRows(lastRenderedRows, lastRenderParams.secured, lastRenderParams.selectedUniversity, lastRenderParams.levelOfStudy, lastRenderParams.selectedCountry);
      };
      dropdown.querySelector('.cfd-filter-condition').onclick = function() {
        showConditionSubmenu(dropdown, columnKey, thEl);
      };
      dropdown.querySelector('.cfd-filter-values').onclick = function() {
        openFilterByValuesPanel(columnKey);
      };
      const clearSortBtn = dropdown.querySelector('.cfd-clear-sort');
      if (clearSortBtn) {
        clearSortBtn.onclick = function() {
          delete columnSortState[columnKey];
          closeColumnFilterDropdown();
          if (lastRenderParams) renderRows(lastRenderedRows, lastRenderParams.secured, lastRenderParams.selectedUniversity, lastRenderParams.levelOfStudy, lastRenderParams.selectedCountry);
        };
      }
      const clearFilterBtn = dropdown.querySelector('.cfd-clear-filter');
      if (clearFilterBtn) {
        clearFilterBtn.onclick = function() {
          delete columnFilterState[columnKey];
          closeColumnFilterDropdown();
          if (lastRenderParams) renderRows(lastRenderedRows, lastRenderParams.secured, lastRenderParams.selectedUniversity, lastRenderParams.levelOfStudy, lastRenderParams.selectedCountry);
        };
      }
    }

    function clearConditionBuilders(dropdown) {
      dropdown.querySelectorAll('.cfd-condition').forEach(function(el) { el.remove(); });
    }

    function showConditionSubmenu(dropdown, columnKey, thEl) {
      clearConditionBuilders(dropdown);
      const operators = getOperatorsForColumn(columnKey);
      const sub = document.createElement('div');
      sub.className = 'cfd-submenu is-open';
      sub.innerHTML = operators.map(function(op) { return '<button type="button" class="cfd-item cfd-op" data-operator="' + escapeHtml(op.id) + '">' + escapeHtml(op.label) + '</button>'; }).join('');
      var condRect = dropdown.getBoundingClientRect();
      sub.style.left = (condRect.width + 4) + 'px';
      sub.style.top = '0';
      dropdown.appendChild(sub);
      sub.querySelectorAll('.cfd-op').forEach(function(btn) {
        btn.onclick = function() {
          const opId = btn.dataset.operator;
          const op = FILTER_OPERATORS.find(function(o) { return o.id === opId; });
          sub.remove();
          showConditionInputs(dropdown, columnKey, op, thEl);
        };
      });
    }

    function showConditionInputs(dropdown, columnKey, op, thEl) {
      clearConditionBuilders(dropdown);
      const kind = op.inputKind;
      let html = '<div class="cfd-condition"><label>' + escapeHtml(op.label) + '</label>';
      if (kind === 'text' || kind === 'typeAware') {
        const ph = kind === 'text' ? 'Enter text' : (getColumnType(columnKey) === 'number' ? 'Enter value' : 'Enter text');
        html += '<input type="' + (getColumnType(columnKey) === 'number' ? 'number' : 'text') + '" class="cfd-input cfd-value" placeholder="' + ph + '"/>';
      } else if (kind === 'number') {
        html += '<input type="number" class="cfd-input cfd-value" placeholder="Enter value"/>';
      } else if (kind === 'numberRange') {
        html += '<input type="number" class="cfd-input cfd-value" placeholder="From"/> <input type="number" class="cfd-input cfd-value2" placeholder="To"/>';
      }
      html += '<div class="cfd-condition-ok"><button type="button" class="btn cfd-ok">OK</button></div></div>';
      const wrap = document.createElement('div');
      wrap.innerHTML = html;
      dropdown.appendChild(wrap.firstElementChild);
      const conditionDiv = dropdown.querySelector('.cfd-condition');
      const okBtn = conditionDiv.querySelector('.cfd-ok');
      const existing = columnFilterState[columnKey] && columnFilterState[columnKey].condition;
      if (existing) {
        const v0 = conditionDiv.querySelector('.cfd-value');
        if (v0) v0.value = existing.value != null ? existing.value : '';
        const v1 = conditionDiv.querySelector('.cfd-value2');
        if (v1) v1.value = existing.value2 != null ? existing.value2 : '';
      }
      okBtn.onclick = function() {
        const valEl = conditionDiv.querySelector('.cfd-value');
        const val2El = conditionDiv.querySelector('.cfd-value2');
        const value = valEl ? valEl.value : '';
        const value2 = val2El ? val2El.value : '';
        if (op.id === 'none') {
          delete columnFilterState[columnKey];
        } else {
          columnFilterState[columnKey] = { type: 'condition', condition: { operator: op.id, value: value, value2: value2 } };
        }
        closeColumnFilterDropdown();
        if (lastRenderParams) renderRows(lastRenderedRows, lastRenderParams.secured, lastRenderParams.selectedUniversity, lastRenderParams.levelOfStudy, lastRenderParams.selectedCountry);
      };
    }

    function openFilterByValuesPanel(columnKey) {
      const panel = ensureFilterByValuesPanel();
      if (!lastRenderParams) return;
      const includePreferredUniversity = !!normalizeText(lastRenderParams.selectedUniversity) && normalizeText(lastRenderParams.selectedUniversity) !== normalizeText(NOT_IN_LIST_UNIVERSITY) && normalizeText(lastRenderParams.selectedCountry) !== normalizeText(NOT_IN_LIST_COUNTRY);
      const cols = getColumns(lastRenderParams.secured, lastRenderParams.selectedUniversity, lastRenderParams.selectedCountry);
      const dataColumns = cols.slice(2);
      const filteredForValues = applyFilters(lastRenderedRows, cols, dataColumns, lastRenderParams.secured, lastRenderParams.selectedUniversity, lastRenderParams.levelOfStudy, lastRenderParams.selectedCountry, columnKey);
      const rowsToUse = hasActiveFilterOrSort() ? applySort(filteredForValues, cols, dataColumns, lastRenderParams.secured, lastRenderParams.selectedUniversity, lastRenderParams.levelOfStudy, lastRenderParams.selectedCountry) : filteredForValues;
      const uniqueValues = [];
      const seen = {};
      rowsToUse.forEach(function(row) {
        const raw = getCellValueForColumn(row, columnKey, dataColumns, lastRenderParams.secured, lastRenderParams.selectedUniversity, institutesList, lastRenderParams.levelOfStudy, includePreferredUniversity);
        const displayStr = getCellDisplayForFilterValues(raw);
        if (!seen[displayStr]) { seen[displayStr] = true; uniqueValues.push(displayStr); }
      });
      uniqueValues.sort(function(a, b) {
        if (a === '(Blanks)') return 1;
        if (b === '(Blanks)') return -1;
        return a.localeCompare(b, undefined, { sensitivity: 'base' });
      });
      const applied = (columnFilterState[columnKey] && columnFilterState[columnKey].type === 'values' && columnFilterState[columnKey].selectedValues) ? columnFilterState[columnKey].selectedValues.slice() : uniqueValues.slice();
      filterByValuesDraft = { columnKey: columnKey, selectedValues: applied.slice(), allValues: uniqueValues };
      panel.querySelector('.fbv-displaying').textContent = 'Displaying ' + applied.length;
      panel.querySelector('.fbv-list').innerHTML = uniqueValues.map(function(v) {
        const checked = applied.indexOf(v) !== -1 ? ' checked' : '';
        return '<label class="fbv-row"><input type="checkbox" data-value="' + escapeHtml(v) + '"' + checked + '/><span>' + escapeHtml(v) + '</span></label>';
      }).join('');
      panel.querySelector('.fbv-search').value = '';
      panel.classList.add('is-open');
      panel.dataset.columnKey = columnKey;
      var th = thead ? Array.prototype.find.call(thead.querySelectorAll('th'), function(t) { return t.getAttribute('data-column-key') === columnKey; }) : null;
      var vw = window.innerWidth || document.documentElement.clientWidth;
      var vh = window.innerHeight || document.documentElement.clientHeight;
      if (th) {
        var rect = th.getBoundingClientRect();
        var panelRect = panel.getBoundingClientRect();
        var gap = 4;
        var topBelow = rect.bottom + gap;
        var topAbove = rect.top - panelRect.height - gap;
        if (topBelow + panelRect.height <= vh - 8) {
          panel.style.top = (rect.bottom + gap) + 'px';
        } else if (topAbove >= 8) {
          panel.style.top = (rect.top - panelRect.height - gap) + 'px';
        } else {
          panel.style.top = Math.max(8, vh - panelRect.height - 8) + 'px';
        }
        var leftUnderColumn = Math.max(8, Math.min(rect.left, vw - panelRect.width - 8));
        panel.style.left = leftUnderColumn + 'px';
      } else {
        var dropdownOpen = columnFilterDropdownEl && columnFilterDropdownEl.classList.contains('is-open');
        if (dropdownOpen && columnFilterDropdownEl.getBoundingClientRect) {
          var dropRect = columnFilterDropdownEl.getBoundingClientRect();
          panel.style.left = dropRect.left + 'px';
          panel.style.top = (dropRect.bottom + 4) + 'px';
          var panelRect = panel.getBoundingClientRect();
          if (panelRect.right > vw) panel.style.left = Math.max(8, vw - panelRect.width - 8) + 'px';
          if (panelRect.left < 8) panel.style.left = '8px';
          if (panelRect.bottom > vh) panel.style.top = Math.max(8, vh - panelRect.height - 8) + 'px';
        } else {
          var tableWrap = document.querySelector('.table-wrap');
          var tr = tableWrap ? tableWrap.getBoundingClientRect() : null;
          if (tr) { panel.style.left = (tr.left + 8) + 'px'; panel.style.top = (tr.top + 50) + 'px'; }
        }
      }
      function updateDisplaying() {
        var chks = panel.querySelectorAll('.fbv-list input:checked');
        panel.querySelector('.fbv-displaying').textContent = 'Displaying ' + chks.length;
        filterByValuesDraft.selectedValues = Array.from(chks).map(function(c) { return c.dataset.value; });
      }
      panel.querySelectorAll('.fbv-list input').forEach(function(cb) {
        cb.onchange = updateDisplaying;
      });
      panel.querySelector('.fbv-select-all').onclick = function() {
        panel.querySelectorAll('.fbv-list input').forEach(function(c) { c.checked = true; });
        updateDisplaying();
      };
      panel.querySelector('.fbv-clear').onclick = function() {
        panel.querySelectorAll('.fbv-list input').forEach(function(c) { c.checked = false; });
        updateDisplaying();
      };
      panel.querySelector('.fbv-search').oninput = function() {
        var q = (this.value || '').toLowerCase();
        panel.querySelectorAll('.fbv-row').forEach(function(row) {
          var text = (row.textContent || '').toLowerCase();
          row.style.display = q && !text.includes(q) ? 'none' : '';
        });
      };
      panel.querySelector('.fbv-cancel').onclick = function() {
        panel.classList.remove('is-open');
        filterByValuesDraft = null;
      };
      panel.querySelector('.fbv-ok').onclick = function() {
        columnFilterState[columnKey] = { type: 'values', selectedValues: filterByValuesDraft.selectedValues.slice() };
        panel.classList.remove('is-open');
        filterByValuesDraft = null;
        if (lastRenderParams) renderRows(lastRenderedRows, lastRenderParams.secured, lastRenderParams.selectedUniversity, lastRenderParams.levelOfStudy, lastRenderParams.selectedCountry);
      };
    }

    function bindColumnFilterDropdown() {
      if (thead.dataset.columnFilterBound) return;
      thead.dataset.columnFilterBound = '1';
      thead.addEventListener('change', function(e) {
        const selectAll = e.target.closest('.select-all-offers');
        if (selectAll) {
          const checked = selectAll.checked;
          resultsBody.querySelectorAll('.offer-checkbox').forEach(function(cb) { cb.checked = checked; });
          return;
        }
      });
      thead.addEventListener('click', function(e) {
        const selectAll = e.target.closest('.select-all-offers');
        if (selectAll) {
          e.stopPropagation();
          return;
        }
        const infoIcon = e.target.closest('.th-info-icon');
        if (infoIcon) {
          e.preventDefault();
          e.stopPropagation();
          const text = infoIcon.getAttribute('data-column-tooltip');
          if (text) openHeaderInfoPopover(text, infoIcon);
          return;
        }
        handleThHeadClick(e);
      });
    }

    function handleThHeadClick(e) {
      if (e.target.closest('.th-info-icon')) return;
      const sortFilterIcon = e.target.closest('.th-sort-filter-icon');
      if (!sortFilterIcon) return;
      const th = sortFilterIcon.closest('th');
      if (!th || !th.dataset.columnKey) return;
      e.preventDefault();
      e.stopPropagation();
      openColumnFilterPanel(th.dataset.columnKey, th);
    }
    var audienceBadgeMobile = window.matchMedia('(max-width: 991px)');
    if (resultsBody) {
      resultsBody.addEventListener('click', function(e) {
        var badge = e.target.closest('.audience-badge');
        if (!badge || !audienceBadgeMobile.matches) return;
        var text = badge.getAttribute('data-audience-tooltip');
        if (!text) return;
        e.preventDefault();
        e.stopPropagation();
        if (headerInfoPopoverEl && headerInfoPopoverEl.classList.contains('is-open') && headerInfoPopoverEl.textContent === text) {
          closeHeaderInfoPopover();
        } else {
          openHeaderInfoPopover(text, badge);
        }
      });
    }
    document.addEventListener('click', function(e) {
      if (!document.contains(e.target)) return;
      var insideDropdown = columnFilterDropdownEl && columnFilterDropdownEl.contains(e.target);
      var insidePanel = filterByValuesPanelEl && filterByValuesPanelEl.contains(e.target);
      var insideInfoPopover = headerInfoPopoverEl && headerInfoPopoverEl.contains(e.target);
      var onThInfoIcon = e.target.closest('.th-info-icon');
      var onSortFilterIcon = e.target.closest('.th-sort-filter-icon');
      var onAudienceBadge = e.target.closest('.audience-badge');
      if (!insideInfoPopover && !onThInfoIcon && !onAudienceBadge && headerInfoPopoverEl && headerInfoPopoverEl.classList.contains('is-open')) closeHeaderInfoPopover();
      if (insideDropdown || insidePanel || onSortFilterIcon) return;
      if (columnFilterDropdownEl && columnFilterDropdownEl.classList.contains('is-open')) closeColumnFilterDropdown();
      if (filterByValuesPanelEl && filterByValuesPanelEl.classList.contains('is-open')) {
        filterByValuesPanelEl.classList.remove('is-open');
        filterByValuesDraft = null;
      }
    });
    document.addEventListener('keydown', function(e) {
      if (e.key === 'Escape') {
        if (headerInfoPopoverEl && headerInfoPopoverEl.classList.contains('is-open')) {
          closeHeaderInfoPopover();
        } else {
          closeColumnFilterDropdown();
        }
        if (filterByValuesPanelEl && filterByValuesPanelEl.classList.contains('is-open')) {
          filterByValuesPanelEl.classList.remove('is-open');
          filterByValuesDraft = null;
        }
      }
    });

    function renderRows(rows, secured, selectedUniversity, levelOfStudy, selectedCountry) {
      const orderedRows = Array.isArray(rows) ? rows.slice() : [];
      for (const row of orderedRows) {
        const bankSlug = normalizeSlug(row && row.bankSlug);
        const lenderKey = normalizeText(row && row.bankName);
        if (!lenderKey) continue;
        if (!lenderStableOrder.has(lenderKey)) {
          if (bankSlug && bankManifestOrderBySlug.has(bankSlug)) {
            lenderStableOrder.set(lenderKey, bankManifestOrderBySlug.get(bankSlug));
          } else {
            lenderStableOrder.set(lenderKey, lenderStableOrderCounter++);
          }
        }
      }
      if (ENABLE_STABLE_RESULTS_ORDER) {
        orderedRows.sort(compareRowsForStableOrder);
      }
      const selectedUniversityNorm = normalizeText(selectedUniversity);
      const selectedCountryNorm = normalizeText(selectedCountry);
      const includePreferredUniversity = !!selectedUniversityNorm
        && selectedUniversityNorm !== normalizeText(NOT_IN_LIST_UNIVERSITY)
        && selectedCountryNorm !== normalizeText(NOT_IN_LIST_COUNTRY);
      const cols = getColumns(secured, selectedUniversity, selectedCountry);
      const dataColumns = cols.slice(2);
      const colCount = cols.length + 1;
      lastRenderedRows = orderedRows;
      lastRenderParams = { secured: secured, selectedUniversity: selectedUniversity, levelOfStudy: levelOfStudy, selectedCountry: selectedCountry };
      if (!orderedRows.length) {
        countEl.textContent = '0 matches.';
        thead.innerHTML = buildHeaderRow(cols);
        resultsBody.innerHTML = '<tr><td colspan="' + colCount + '" class="empty">No banks with matching offers for this criteria.</td></tr>';
        previousRenderSnapshot = { byExactKey: new Map(), byGroupKey: new Map() };
        bindColumnFilterDropdown();
        return;
      }
      if (hasActiveFilterOrSort()) {
        const filtered = applyFilters(orderedRows, cols, dataColumns, secured, selectedUniversity, levelOfStudy, selectedCountry, null);
        const filteredAndSorted = applySort(filtered, cols, dataColumns, secured, selectedUniversity, levelOfStudy, selectedCountry);
        renderRowsFlat(filteredAndSorted, secured, selectedUniversity, levelOfStudy, selectedCountry);
        return;
      }
      const canDiffWithPrevious = ENABLE_DIFF_HIGHLIGHT
        && !!previousRenderSnapshot;
      const currentSnapshotEntries = [];
      thead.innerHTML = buildHeaderRow(cols);

      const bankGroups = [];
      const seen = new Set();
      const lenderSectorMap = new Map();
      for (const row of orderedRows) {
        const lender = row.bankName;
        const sectorVal = row.sector != null ? String(row.sector).trim() : '';
        if (!lenderSectorMap.has(lender)) {
          lenderSectorMap.set(lender, sectorVal || 'N/A');
        } else {
          const existing = lenderSectorMap.get(lender);
          if ((!existing || existing === 'N/A') && sectorVal) {
            lenderSectorMap.set(lender, sectorVal);
          }
        }
      }
      for (const row of orderedRows) {
        const name = row.bankName;
        if (!seen.has(name)) {
          seen.add(name);
          bankGroups.push(orderedRows.filter(r => r.bankName === name));
        }
      }

      countEl.innerHTML = `<strong>${orderedRows.length}</strong> offer${orderedRows.length === 1 ? '' : 's'} from <strong>${bankGroups.length}</strong> bank${bankGroups.length === 1 ? '' : 's'}.`;

      const tableRows = bankGroups.map((group, bankIdx) => {
        const bankName = group[0].bankName;
        const sector = lenderSectorMap.get(bankName) || 'N/A';
        const n = group.length;
        const consumedPreviousEntries = new Set();
        const rowsHtml = group.map((row, i) => {
          const exactKey = getOfferExactKey(row);
          const groupKey = getOfferCompareGroupKey(row);
          const cells = getOfferCells(row, secured, selectedUniversity, institutesList, levelOfStudy, includePreferredUniversity);
          const comparableCells = cells.map(cellComparableValue);
          const comparableByColumn = {};
          for (let idx = 0; idx < dataColumns.length; idx++) {
            comparableByColumn[dataColumns[idx]] = comparableCells[idx];
          }
          currentSnapshotEntries.push({ exactKey, groupKey, comparableCells, comparableByColumn });
          let prevComparableCells = null;
          let prevComparableByColumn = null;
          if (canDiffWithPrevious) {
            if (exactKey && previousRenderSnapshot.byExactKey.has(exactKey)) {
              const exactMatch = previousRenderSnapshot.byExactKey.get(exactKey);
              prevComparableCells = exactMatch.comparableCells;
              prevComparableByColumn = exactMatch.comparableByColumn || null;
              consumedPreviousEntries.add(exactMatch.entryId);
            } else if (groupKey && previousRenderSnapshot.byGroupKey.has(groupKey)) {
              const candidates = previousRenderSnapshot.byGroupKey.get(groupKey);
              const candidate = candidates.find((item) => !consumedPreviousEntries.has(item.entryId));
              if (candidate) {
                prevComparableCells = candidate.comparableCells;
                prevComparableByColumn = candidate.comparableByColumn || null;
                consumedPreviousEntries.add(candidate.entryId);
              }
            }
          }
          const checkboxTd = '<td class="offer-checkbox-cell"><input type="checkbox" class="offer-checkbox" aria-label="Select offer"></td>';
          const tds = cells.map((cell, cellIdx) => {
            const columnName = dataColumns[cellIdx];
            const dataCol = ` data-column-key="${escapeHtml(columnName)}"`;
            const hasComparableColumn = !!(prevComparableByColumn && columnName && Object.prototype.hasOwnProperty.call(prevComparableByColumn, columnName));
            const hasComparableIndex = Array.isArray(prevComparableCells) && cellIdx < prevComparableCells.length;
            const previousCellValue = hasComparableColumn
              ? prevComparableByColumn[columnName]
              : (hasComparableIndex ? prevComparableCells[cellIdx] : null);
            const isChangedCell = previousCellValue != null && previousCellValue !== comparableCells[cellIdx];
            const cls = typeof cell === 'number' ? 'num' : '';
            if (cell && typeof cell === 'object' && cell.kind === 'interestAudience') {
              const rate = escapeHtml(cell.rate || 'N/A');
              const audience = escapeHtml(cell.audience || 'N/A');
              const audienceTooltip = getAudienceTooltip(cell.audience);
              const sortValue = Number.isFinite(cell.rateNumber) ? String(cell.rateNumber) : '';
              const searchValue = [cell.rateText || '', cell.audience || ''].join(' ').trim();
              const rateCellClass = [cls, 'interest-rate-cell', isChangedCell ? 'changed-cell' : ''].filter(Boolean).join(' ');
              const badgeTitle = audienceTooltip ? ` title="${escapeHtml(audienceTooltip)}"` : '';
              const badgeDataTooltip = audienceTooltip ? ` data-audience-tooltip="${escapeHtml(audienceTooltip)}"` : '';
              return `<td class="${rateCellClass}"${dataCol} data-rate-number="${escapeHtml(sortValue)}" data-rate-text="${escapeHtml(searchValue)}"><span class="audience-rate"><span>${rate}</span><span class="audience-badge"${badgeTitle}${badgeDataTooltip}>${audience}</span></span></td>`;
            }
            if (cell && typeof cell === 'object' && cell.kind === 'listedUniversityOnly') {
              const label = escapeHtml(cell.label || 'Listed Only');
              const bank = escapeHtml(cell.bankName || bankName || '');
              const criteria = escapeHtml(cell.criteria || '');
              const cellClass = [cls, isChangedCell ? 'changed-cell' : ''].filter(Boolean).join(' ');
              return `<td class="${cellClass}"${dataCol}><button type="button" class="listed-universities-trigger" data-listed-bank="${bank}" data-listed-criteria="${criteria}">${label}</button></td>`;
            }
            const cellClass = [cls, isChangedCell ? 'changed-cell' : ''].filter(Boolean).join(' ');
            return `<td class="${cellClass}"${dataCol}>${cell ?? 'N/A'}</td>`;
          }).join('');
          const isFirst = i === 0;
          const isLast = i === n - 1;
          let trClass = '';
          if (isFirst) trClass = ' bank-group-first';
          if (isLast) trClass += ' bank-group-last';
          if (isFirst) {
            return '<tr class="bank-block' + trClass + '"><td rowspan="' + n + '" class="bank-name-cell"><span class="lender-name">' + escapeHtml(bankName) + '</span><button type="button" class="view-details-trigger" data-details-bank="' + escapeHtml(bankName) + '">View Details</button></td><td rowspan="' + n + '" class="sector-name-cell">' + escapeHtml(sector) + '</td>' + checkboxTd + tds + '</tr>';
          }
          return '<tr class="bank-block' + trClass + '">' + checkboxTd + tds + '</tr>';
        });
        return rowsHtml.join('');
      }).join('');
      resultsBody.innerHTML = tableRows;
      const byExactKey = new Map();
      const byGroupKey = new Map();
      currentSnapshotEntries.forEach((entry, idx) => {
        const stored = {
          entryId: idx,
          exactKey: entry.exactKey,
          groupKey: entry.groupKey,
          comparableCells: entry.comparableCells,
          comparableByColumn: entry.comparableByColumn
        };
        if (entry.exactKey) byExactKey.set(entry.exactKey, stored);
        if (entry.groupKey) {
          if (!byGroupKey.has(entry.groupKey)) byGroupKey.set(entry.groupKey, []);
          byGroupKey.get(entry.groupKey).push(stored);
        }
      });
      previousRenderSnapshot = {
        byExactKey,
        byGroupKey
      };
      bindColumnFilterDropdown();
    }

    async function runQueryFromForm() {
      showError('');
      querySummary.textContent = '';
      const gender = form.gender.value;
      const amountRaw = (form.amount.value || '').replace(/,/g, '');
      const amount = amountRaw ? Number(amountRaw) : 0;
      const secured = form.secured.value === 'true';
      const country = (form.country && form.country.value) ? form.country.value.trim() : '';
      const university = (form.university && form.university.value) ? form.university.value.trim() : '';
      const levelOfStudy = (form.levelOfStudy && form.levelOfStudy.value) ? form.levelOfStudy.value.trim() : '';
      const query = { gender, amount, secured, country, university, levelOfStudy };
      const runId = ++queryRunCounter;
      runBtn.disabled = true;
      form.classList.add('loading');
      try {
        const res = await fetch('/api/query-all', {
          method: 'POST',
          headers: { 'Content-Type': 'application/json' },
          body: JSON.stringify(query)
        });
        const text = await res.text();
        let data;
        try {
          data = text ? JSON.parse(text) : {};
        } catch (_) {
          if (runId !== queryRunCounter) return;
          showError(res.status === 404 ? 'API not found. Open this app at http://localhost:3080 (run "npm start" in the Table folder).' : ('Server error: ' + (text || res.statusText || 'Invalid response')));
          renderRows([], secured, '', '', country);
          return;
        }
        if (runId !== queryRunCounter) return;
        if (!res.ok) {
          showError(data.error || 'Request failed');
          renderRows([], secured, '', '', country);
          return;
        }
        const securedResp = data.secured !== false;
        const selectedUniv = university || '';
        const levelOfStudyVal = (form.levelOfStudy && form.levelOfStudy.value) ? form.levelOfStudy.value.trim() : '';
        renderRows(data.rows || [], securedResp, selectedUniv, levelOfStudyVal, country);
        const parts = [`Gender=${gender}`, `Amount=₹${amount.toLocaleString('en-IN')}`, secured ? 'Secured' : 'Unsecured'];
        if (country) parts.push(`Country=${country}`);
        if (selectedUniv) parts.push(`University=${selectedUniv}`);
        else parts.push('University=Not in the list');
        if (levelOfStudy && levelOfStudy !== 'Any') parts.push(`Level=${levelOfStudy}`);
        querySummary.textContent = '';
      } catch (err) {
        if (runId !== queryRunCounter) return;
        showError(err.message || 'Network error');
        renderRows([], form.secured.value === 'true', '', '', country);
      } finally {
        if (runId === queryRunCounter) {
          runBtn.disabled = false;
          form.classList.remove('loading');
        }
      }
    }

    function scheduleAutoRun() {
      if (autoRunTimer) clearTimeout(autoRunTimer);
      autoRunTimer = setTimeout(() => {
        autoRunTimer = null;
        runQueryFromForm();
      }, 280);
    }

    form.addEventListener('submit', async (e) => {
      e.preventDefault();
      if (autoRunTimer) {
        clearTimeout(autoRunTimer);
        autoRunTimer = null;
      }
      runQueryFromForm();
    });

    async function loadAndRunDefault() {
      try {
        const defaultQuery = { gender: 'Female', amount: 7000000, secured: true };
        const res = await fetch('/api/query-all', {
          method: 'POST',
          headers: { 'Content-Type': 'application/json' },
          body: JSON.stringify(defaultQuery)
        });
        const text = await res.text();
        let data;
        try {
          data = text ? JSON.parse(text) : {};
        } catch (_) {
          return;
        }
        if (res.ok && data) {
          renderRows(data.rows || [], data.secured !== false, '', 'Any', '');
          form.gender.value = defaultQuery.gender;
          setAmountDisplay(defaultQuery.amount);
          form.secured.value = String(defaultQuery.secured);
        }
      } catch (_) {}
    }

    document.body.addEventListener('click', function(e) {
      const listedTrigger = e.target.closest('.listed-universities-trigger');
      if (listedTrigger) {
        const bankName = listedTrigger.getAttribute('data-listed-bank') || '';
        const criteria = listedTrigger.getAttribute('data-listed-criteria') || '';
        openListedPopupForBank(bankName, criteria);
        return;
      }

      const detailsTrigger = e.target.closest('.view-details-trigger');
      if (detailsTrigger) {
        const lenderName = detailsTrigger.getAttribute('data-details-bank') || '';
        openDetailsPopupForLender(lenderName);
        return;
      }

      const modeToggle = e.target.closest('[data-listed-mode-toggle]');
      if (modeToggle) {
        if (!listedPopupState.bankName) return;
        listedPopupState.mode = listedPopupState.mode === 'bank' ? 'criteria' : 'bank';
        renderListedPopupContent(listedPopupState.bankName, listedPopupState.criteria, listedPopupState.mode);
        return;
      }

      const closeListed = e.target.closest('[data-close-listed-popup]');
      if (closeListed) {
        closeListedPopup();
        return;
      }

      const closeDetails = e.target.closest('[data-close-details-popup]');
      if (closeDetails) {
        closeDetailsPopup();
        return;
      }

      if (listedPopupBackdrop && e.target === listedPopupBackdrop) {
        closeListedPopup();
        return;
      }

      if (detailsPopupBackdrop && e.target === detailsPopupBackdrop) {
        closeDetailsPopup();
        return;
      }

      const star = e.target.closest('.refundable-star');
      if (!star) return;
      const existing = document.getElementById('refundable-tooltip');
      if (existing) existing.remove();
      const tip = document.createElement('div');
      tip.id = 'refundable-tooltip';
      tip.className = 'refundable-tooltip';
      tip.textContent = 'Refundable';
      tip.style.left = '-9999px';
      document.body.appendChild(tip);
      const r = star.getBoundingClientRect();
      requestAnimationFrame(function() {
        tip.style.left = Math.max(4, r.right - tip.offsetWidth) + 'px';
        tip.style.top = (r.top - tip.offsetHeight - 6) + 'px';
      });
      setTimeout(function() { tip.remove(); }, 2000);
    });

    document.body.addEventListener('input', function(e) {
      const search = e.target.closest('#listed-popup-search');
      if (!search || !listedPopupState.bankName) return;
      listedPopupState.search = search.value || '';
      renderListedPopupContent(listedPopupState.bankName, listedPopupState.criteria, listedPopupState.mode);
    });

    document.addEventListener('keydown', function (e) {
      if (e.key === 'Escape' && listedPopupBackdrop && listedPopupBackdrop.style.display !== 'none') {
        closeListedPopup();
        return;
      }
      if (e.key === 'Escape' && detailsPopupBackdrop && detailsPopupBackdrop.style.display !== 'none') {
        closeDetailsPopup();
      }
    });

    function getCountrySelect() { return document.getElementById('country'); }
    function getUniversitySelect() { return document.getElementById('university'); }
    function getCountryMenu() { return document.getElementById('country-menu'); }
    function getUniversityMenu() { return document.getElementById('university-menu'); }
    function getLevelSelect() { return document.getElementById('levelOfStudy'); }
    function getLevelMenu() { return document.getElementById('level-menu'); }
    function getCountryToggle() { return document.getElementById('country-toggle'); }
    function getUniversityToggle() { return document.getElementById('university-toggle'); }
    function getLevelToggle() { return document.getElementById('level-toggle'); }
    function getCountryClear() { return document.getElementById('country-clear'); }
    function getUniversityClear() { return document.getElementById('university-clear'); }
    function getLevelClear() { return document.getElementById('level-clear'); }

    function hideComboMenus() {
      const cm = getCountryMenu();
      const um = getUniversityMenu();
      const lm = getLevelMenu();
      if (cm) cm.style.display = 'none';
      if (um) um.style.display = 'none';
      if (lm) lm.style.display = 'none';
    }

    function setClearVisible(button, visible) {
      if (!button) return;
      button.style.display = visible ? 'block' : 'none';
    }

    function syncClearButtons() {
      const country = getCountrySelect();
      const university = getUniversitySelect();
      const level = getLevelSelect();
      setClearVisible(getCountryClear(), !!(country && String(country.value || '').trim()));
      setClearVisible(getUniversityClear(), !!(university && String(university.value || '').trim()));
      setClearVisible(getLevelClear(), !!(level && String(level.value || '').trim()));
    }

    function renderComboMenu(kind, forceOpen) {
      const input = kind === 'country' ? getCountrySelect() : (kind === 'university' ? getUniversitySelect() : getLevelSelect());
      const menu = kind === 'country' ? getCountryMenu() : (kind === 'university' ? getUniversityMenu() : getLevelMenu());
      const options = kind === 'country' ? countryOptions : (kind === 'university' ? universityOptions : levelOptions);
      if (!input || !menu) return;
      const search = forceOpen ? '' : String(input.value || '').trim().toLowerCase();
      if (!forceOpen && !search) {
        menu.style.display = 'none';
        menu.innerHTML = '';
        return;
      }
      const filtered = options.filter((v) => !search || String(v).toLowerCase().includes(search));
      if (!filtered.length) {
        menu.style.display = 'none';
        menu.innerHTML = '';
        return;
      }
      menu.innerHTML = filtered.map((v) => '<button type="button" class="combo-option" data-value="' + escapeHtml(v) + '">' + escapeHtml(v) + '</button>').join('');
      menu.style.display = 'block';
    }

    

    function findCountryForUniversity(universityName) {
      const target = normalizeText(universityName);
      if (!target || target === normalizeText(NOT_IN_LIST_UNIVERSITY)) return '';
      const match = (institutesList || []).find((row) => normalizeText(row.university) === target && row.country);
      return match && match.country ? String(match.country).trim() : '';
    }

    function updateUniversityPlaceholder() {
      const university = getUniversitySelect();
      const country = getCountrySelect();
      if (!university) return;
      const countryValue = country && country.value ? String(country.value).trim() : '';
      const isCountryNotInList = normalizeText(countryValue) === normalizeText(NOT_IN_LIST_COUNTRY);
      university.placeholder = isCountryNotInList
        ? UNIVERSITY_PLACEHOLDER_COUNTRY_NOT_LISTED
        : UNIVERSITY_PLACEHOLDER_DEFAULT;
    }

    function syncCountryFromUniversity(universityName) {
      const countryValue = findCountryForUniversity(universityName);
      const country = getCountrySelect();
      if (!country || !countryValue) return;
      const currentCountry = country.value ? String(country.value).trim() : '';
      if (normalizeText(currentCountry) === normalizeText(NOT_IN_LIST_COUNTRY)) return;
      country.value = countryValue;
      populateUniversities();
    }

    function bindComboHandlers() {
      const country = getCountrySelect();
      const university = getUniversitySelect();
      const level = getLevelSelect();
      const countryToggle = getCountryToggle();
      const universityToggle = getUniversityToggle();
      const levelToggle = getLevelToggle();
      const countryMenu = getCountryMenu();
      const universityMenu = getUniversityMenu();
      const levelMenu = getLevelMenu();
      const countryClear = getCountryClear();
      const universityClear = getUniversityClear();
      const levelClear = getLevelClear();

      if (country) {
        country.addEventListener('input', function () {
          populateUniversities();
          renderComboMenu('country', false);
          syncClearButtons();
        });
        country.addEventListener('focus', function () {
          hideComboMenus();
          renderComboMenu('country', true);
        });
        country.addEventListener('click', function () {
          hideComboMenus();
          renderComboMenu('country', true);
        });
      }
      if (university) {
        university.addEventListener('input', function () {
          renderComboMenu('university', false);
          syncClearButtons();
        });
        university.addEventListener('change', function () {
          syncCountryFromUniversity(university.value || '');
          syncClearButtons();
        });
        university.addEventListener('focus', function () {
          hideComboMenus();
          renderComboMenu('university', true);
        });
        university.addEventListener('click', function () {
          hideComboMenus();
          renderComboMenu('university', true);
        });
      }
      if (level) {
        level.addEventListener('input', function () {
          renderComboMenu('level', false);
          syncClearButtons();
        });
        level.addEventListener('focus', function () {
          hideComboMenus();
          renderComboMenu('level', true);
        });
        level.addEventListener('click', function () {
          hideComboMenus();
          renderComboMenu('level', true);
        });
      }

      if (countryClear) {
        countryClear.addEventListener('click', function () {
          if (country) country.value = '';
          populateUniversities();
          hideComboMenus();
          syncClearButtons();
          scheduleAutoRun();
        });
      }
      if (universityClear) {
        universityClear.addEventListener('click', function () {
          if (university) university.value = '';
          hideComboMenus();
          syncClearButtons();
          scheduleAutoRun();
        });
      }
      if (levelClear) {
        levelClear.addEventListener('click', function () {
          if (level) level.value = '';
          hideComboMenus();
          syncClearButtons();
          scheduleAutoRun();
        });
      }

      if (countryToggle) {
        countryToggle.addEventListener('click', function (e) {
          e.preventDefault();
          const open = countryMenu && countryMenu.style.display === 'block';
          hideComboMenus();
          if (!open) renderComboMenu('country', true);
        });
      }
      if (universityToggle) {
        universityToggle.addEventListener('click', function (e) {
          e.preventDefault();
          const open = universityMenu && universityMenu.style.display === 'block';
          hideComboMenus();
          if (!open) renderComboMenu('university', true);
        });
      }
      if (levelToggle) {
        levelToggle.addEventListener('click', function (e) {
          e.preventDefault();
          const open = levelMenu && levelMenu.style.display === 'block';
          hideComboMenus();
          if (!open) renderComboMenu('level', true);
        });
      }

      if (countryMenu) {
        countryMenu.addEventListener('click', function (e) {
          const opt = e.target.closest('.combo-option');
          if (!opt) return;
          const value = opt.getAttribute('data-value') || '';
          if (country) country.value = value;
          populateUniversities();
          scheduleAutoRun();
          hideComboMenus();
          syncClearButtons();
        });
      }
      if (universityMenu) {
        universityMenu.addEventListener('click', function (e) {
          const opt = e.target.closest('.combo-option');
          if (!opt) return;
          const value = opt.getAttribute('data-value') || '';
          if (university) university.value = value;
          syncCountryFromUniversity(value);
          scheduleAutoRun();
          hideComboMenus();
          syncClearButtons();
        });
      }
      if (levelMenu) {
        levelMenu.addEventListener('click', function (e) {
          const opt = e.target.closest('.combo-option');
          if (!opt) return;
          const value = opt.getAttribute('data-value') || '';
          if (level) level.value = value;
          scheduleAutoRun();
          hideComboMenus();
          syncClearButtons();
        });
      }

      document.addEventListener('click', function (e) {
        const inCountry = e.target.closest('#country-combo');
        const inUniversity = e.target.closest('#university-combo');
        const inLevel = e.target.closest('#level-combo');
        if (!inCountry && !inUniversity && !inLevel) hideComboMenus();
      });
    }

    

    function populateCountries() {
      const countries = [...new Set(institutesList.map((i) => i.country).filter(Boolean))].sort();
      const sel = getCountrySelect();
      if (!sel) return;
      countryOptions = [NOT_IN_LIST_COUNTRY].concat(countries);
      const current = sel.value;
      if (countryOptions.includes(current)) sel.value = current;
      const hint = document.getElementById('institutes-hint');
      if (hint) hint.style.display = countries.length ? 'none' : 'block';
      populateUniversities();
    }

    function escapeHtml(s) {
      const div = document.createElement('div');
      div.textContent = s;
      return div.innerHTML;
    }

    function cleanInstituteText(value) {
      if (value == null) return '';
      let text = String(value).trim();
      if (!text) return '';
      text = text.replace(/""/g, '"');
      text = text.replace(/^\s*"+/, '').replace(/"+\s*$/, '').trim();
      return text;
    }

    function normalizeInstituteRow(row) {
      if (!row || typeof row !== 'object') return row;
      const normalized = { ...row };
      let university = row.university != null ? String(row.university).trim() : '';
      let country = row.country != null ? String(row.country).trim() : '';
      const criteria = row.criteria != null ? String(row.criteria).trim() : '';
      const hasSplitUniversity = /^\s*"/.test(university) && /"\s*$/.test(country);
      let normalizedCriteria = cleanInstituteText(criteria);
      if (hasSplitUniversity) {
        const left = cleanInstituteText(university);
        const right = cleanInstituteText(country);
        university = [left, right].filter(Boolean).join(', ');
        country = cleanInstituteText(criteria) || right;
        // For split rows, criteria field is often shifted and unreliable.
        normalizedCriteria = '';
      } else {
        university = cleanInstituteText(university);
        country = cleanInstituteText(country);
        normalizedCriteria = sanitizeCriteriaLabel(normalizedCriteria, country);
      }
      normalized.lenderName = cleanInstituteText(row.lenderName);
      normalized.university = university;
      normalized.country = country;
      normalized.criteria = normalizedCriteria;
      normalized.course = cleanInstituteText(row.course);
      return normalized;
    }

    function populateUniversities() {
      const countrySel = getCountrySelect();
      const univSel = getUniversitySelect();
      if (!univSel) return;
      const country = countrySel && countrySel.value ? countrySel.value.trim() : '';
      const isCountryNotInList = normalizeText(country) === normalizeText(NOT_IN_LIST_COUNTRY);
      updateUniversityPlaceholder();
      let list = institutesList;
      if (country && !isCountryNotInList) {
        list = list.filter((i) => i.country === country);
      }
      const universities = [NOT_IN_LIST_UNIVERSITY].concat([...new Set(list.map((i) => i.university).filter(Boolean))].sort());
      universityOptions = universities;
      const current = univSel.value;
      if (universities.includes(current)) {
        univSel.value = current;
      } else {
        univSel.value = '';
      }
    }

    async function loadInstitutes() {
      institutesList = [];
      // Try API first, then static JSON (works when server serves from project root)
      const urls = ['/api/institutes', '/data/institutes.json'];
      for (const url of urls) {
        try {
          const res = await fetch(url);
          const text = await res.text();
          if (res.ok && text) {
            const data = JSON.parse(text);
            institutesList = Array.isArray(data) ? data.map(normalizeInstituteRow) : [];
            if (institutesList.length) break;
          }
        } catch (_) {}
      }
      populateCountries();
    }

    async function loadViewDetails() {
      viewDetailsData = null;
      lenderDetailsMap = new Map();
      const urls = ['/data/view-details-abroad.json'];
      for (const url of urls) {
        try {
          const res = await fetch(url);
          const text = await res.text();
          if (res.ok && text) {
            const data = JSON.parse(text);
            viewDetailsData = data;
            buildLenderDetailsMap(viewDetailsData);
            if (lenderDetailsMap.size) break;
          }
        } catch (_) {}
      }
    }

    async function loadBankManifestOrder() {
      bankManifestOrderBySlug.clear();
      const urls = ['/data/banks/manifest.json'];
      for (const url of urls) {
        try {
          const res = await fetch(url);
          const text = await res.text();
          if (!res.ok || !text) continue;
          const data = JSON.parse(text);
          if (!Array.isArray(data)) continue;
          data.forEach((slug, idx) => {
            const key = normalizeSlug(slug);
            if (key) bankManifestOrderBySlug.set(key, idx);
          });
          return;
        } catch (_) {}
      }
    }

    window.addEventListener('DOMContentLoaded', async () => {
      await Promise.all([loadInstitutes(), loadViewDetails(), loadBankManifestOrder()]);
      bindComboHandlers();
      bindFieldLabelInfoIcons();
      syncClearButtons();
      form.addEventListener('input', function (e) {
        const target = e.target;
        if (!target || !target.name) return;
        if (['gender', 'amount', 'secured', 'country', 'university', 'levelOfStudy'].includes(target.name)) {
          scheduleAutoRun();
        }
      });
      form.addEventListener('change', function (e) {
        const target = e.target;
        if (!target || !target.name) return;
        if (['gender', 'amount', 'secured', 'country', 'university', 'levelOfStudy'].includes(target.name)) {
          scheduleAutoRun();
        }
      });
      bindAmountInput();
      loadAndRunDefault();
    });
  </script>
</body>
</html>
